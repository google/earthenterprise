<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>Create custom masks</title>
<link rel="stylesheet" href="../css/styles.css" type="text/css" media="all" />
<link rel="stylesheet" href="../css/containers.css" type="text/css" media="all" />
</head>
<body>
<!-- 4525555.html -->
<div class="container">
<div class="sidebar1">
  <p class="sidebar-toc"><a href="../answer/6153619.html">Supported file formats in GEE</a></p>
  <p class="sidebar-toc"><a href="../answer/6053241.html">Apply alpha masking to imagery</a></p>
  <p class="sidebar-toc"><a href="../answer/172810.html">Import pre-processed data</a></p>
  <p class="sidebar-toc"><a href="../answer/1090589.html">Import a subset of imagery</a></p>
  <p class="sidebar-toc"><a href="../answer/173054.html">Add .kip imagery</a></p>
  <p class="sidebar-toc"><a href="../answer/2882131.html">Vector data handling</a></p>
  <p class="sidebar-toc"><a href="../answer/2760298.html">Google Maps raster background</a></p>
  <p class="sidebar-toc"><a href="../answer/4525555.html" class="current-file">Create custom masks</a></p>
  <p class="sidebar-toc"><a href="../answer/6062318.html">Manage mosaics with virtual rasters</a></p>
  <p class="sidebar-toc"><a href="../answer/6081009.html">Map projection types in GEE 5.1.0</a></p>
  <p class="sidebar-toc"><a href="../answer/6081069.html">Add flat imagery to Mercator map databases in GEE 5.1.0</a></p>
  <p class="sidebar-toc"><a href="../answer/2760457.html">Add KML layers</a></p>
  <p class="sidebar-toc"><a href="../answer/2760534.html">Non-clickable icons</a></p>
  <p class="sidebar-toc"><a href="../answer/173053.html">Map projections</a></p>
  <p class="sidebar-toc"><a href="../answer/1089795.html">Map buttons</a></p>
  <p class="sidebar-toc"><a href="../answer/4492623.html">Create terrain overlays</a></p>
  <p class="sidebar-toc"><a href="../answer/2760655.html">Monitor builds with Twitter</a></p>
</div>
<div class="content"> <a name="top_of_file"></a>
  <p><img src="../art/common/googlelogo_color_260x88dp.png" width="130" height="44" alt="Google logo" /></p>
  <h1><a href="../index.html">Google Earth Enterprise Documentation Home</a> | Fusion resources and projects</h1>
  <h2>Create custom masks</h2>
  <hr/>
  <h2>Table of Contents</h2>
  <ul class="no-bullets">
    <li><a href="#h.1a7gtk-is51jk">Getting started</a></li>
    <li><a href="#h.9ywawe-6mtf5w">How to use this guide</a></li>
    <li><a href="#h.o15wae-yhvmf0">What is gepolymaskgen?</a></li>
    <li><a href="#h.q755la-khb6k2">What is gemaskgen?</a></li>
    <li><a href="#h.72rojo-cole53">Useful information about gepolymaskgen</a></li>
    <li><a href="#h.dih5zm-ijmhsm">Useful information about gemaskgen</a></li>
    <li><a href="#h.15mqi8-ulnwei">When to use gepolymaskgen</a></li>
    <li><a href="#h.fwos0-p5skhq">When to use gemaskgen</a></li>
    <li><a href="#h.3zfe5m-jk46gp">Recommended tools for creating custom mask files</a></li>
    <li><a href="#h.wlmas2-m402u4">gepolymaskgen command usage</a></li>
    <li><a href="#h.3x0ypw-108xde">Example use cases and commands to build custom masks</a>
      <ul class="no-bullets">
        <li><a href="#h.qszedw-11begv">Case 1: Create custom masks for imagery which has no fill pixels (usable imagery goes to the edges)</a>
          <ul class="no-bullets">
            <li><a href="#h.mbcmn2-1t1ovi">Example A: Creating an edge-matched mask with no feather</a></li>
            <li><a href="#h.iwshjk-8eno4v">Example B: Creating an edge-matched mask with a fixed value feather</a></li>
          </ul>
        </li>
        <li><a href="#h.3n4rc-ctite1">Case 2: Create custom masks for islands</a>
          <ul class="no-bullets">
            <li><a href="#h.y33yje-634qnl">Example A: Create a custom edge-matched mask for an island that masks into the land</a></li>
            <li><a href="#h.o53yvg-84blkd">Example B: Create a custom edge-matched mask for an island that masks into the water</a></li>
          </ul>
        </li>
        <li><a href="#h.bx3u98-pvlwqy">Case 3: Create custom masks with coastlines and shared edges with other imagery resources</a>
          <ul class="no-bullets">
            <li><a href="#h.frsdlq-dl14oj">Example A: Create an edge-matched custom mask that feathers coastlines and external edges with the same feather value</a></li>
            <li><a href="#h.liqys0-bdy6ft">Example B: Create an edge-matched custom mask with feathered coastlines and feathered external edges</a></li>
            <li><a href="#h.vwnw2u-5ziegd">Example C: Feathered internal coastline and no-feather external edge</a></li>
          </ul>
        </li>
        <li><a href="#h.d2mv1m-pa0xwq">Case 4: Masking out sections within an image resource</a>
          <ul class="no-bullets">
            <li><a href="#h.u7hsy2-gulr1j">Example A: Creating an edge-matched mask with a feathered edge and masking missing internal imagery in one step</a></li>
            <li><a href="#h.ybl84i-pp3qv8">Example B: Creating an edge-matched mask with a feathered edge and masking missing internal imagery in two steps</a></li>
          </ul>
        </li>
        <li><a href="#h.6wiupq-gddwoq">Case 5: Building custom masks with both gemaskgen and gepolymaskgen</a></li>
      </ul>
    </li>
    <li><a href="#h.wwsxau-f5geku">Appendix A: Importing custom masks with imagery and terrain resources in Google Earth Enterprise Fusion Pro</a>
      <ul class="no-bullets">
        <li><a href="#h.482jhk-rn8tuq">Example 1: Enable havemask mode in the Fusion GUI for a new image resource</a></li>
        <li><a href="#h.4ca70y-vkbi43">Example 2: Enable havemask mode by command line for a new image resource</a></li>
        <li><a href="#h.mzywb6-etqfmz">Example 3: Enable havemask mode in the Fusion GUI for an existing image resource</a></li>
        <li><a href="#h.utxsvs-euyjjd">Example 4: Enable havemask mode by command line for an existing image resource</a></li>
      </ul>
    </li>
    <li><a href="#h.h6hjk6-u3u8xg">Appendix B: Locating mask files and Fusion format data in an Asset Root</a>
      <ul class="no-bullets">
        <li><a href="#h.1ccxia-clzb9">Example 1: Locate the Fusion format imagery (.kip) and mask (.kmp) files of an image resource</a></li>
        <li><a href="#h.4msdgq-91mbmf">Example 2: Locate a mask.tif file automatically built by the automask feature of a Fusion resource build</a></li>
        <li><a href="#h.36qmui-enjrcd">Example 3: Locate the mask.tif file and Fusion format .kip file utilized for building the Fusion format .kmp (mask product)</a></li>
      </ul>
    </li>
    <li><a href="#h.o23346-tgkrx4">Appendix C: Determining source file raster size with geinfo</a>
      <ul class="no-bullets">
        <li><a href="#h.drylio-qyapcq">Maximum suggested raster dimensions for source files used as gepolymaskgen --base_image files</a></li>
        <li><a href="#h.337igq-k0r1kk">Square-shaped rasters</a></li>
        <li><a href="#h.vxiu8i-47rfer">Rectangular-shaped rasters</a></li>
      </ul>
    </li>
    <li><a href="#h.p9e53m-jf2wqc">Appendix D: Building high resolution mask files with gemaskgen</a></li>
    <li><a href="#h.nt1nwm-ygzycp">Appendix E: Using a Photo Editing application to augment a custom mask</a></li>
    <li><a href="#h.3wwhdu-olys6q">Appendix F: Building custom masks for large source imagery</a></li>
    <li><a href="#h.lafpls-5an7c8">Appendix G: Gepolymaskgen help menu</a></li>
  </ul>
  <hr/>
  <h2><a id="h.1a7gtk-is51jk" name="h.1a7gtk-is51jk"></a>Getting started</h2>
  <p>A new masking tool is now available with Google Earth Enterprise (GEE) Fusion Pro version 4.0 which is able to create very high quality, custom masks for imagery resources. This tool, <code>gepolymaskgen</code>, supports clipping coastlines from imagery resources or arbitrary polygonal shapes from imagery resources, and can be integrated into source file preparation or creating updated masks for existing imagery resources.</p>
  <hr/>
  <h2><a id="h.9ywawe-6mtf5w" name="h.9ywawe-6mtf5w"></a>How to use this guide</h2>
  <p>This guide is intended to provide in-depth information about creating custom masks, the new <code>gepolymaskgen</code> tool, and the existing <code>gemaskgen</code> tool as well as example cases with command sequences to build your own custom masks. You may jump directly to the cases section to build your custom masks and then read the informational sections later, or read the entire guide from start to finish.</p>
  <hr/>
  <h2><a id="h.o15wae-yhvmf0" name="h.o15wae-yhvmf0"></a>What is gepolymaskgen?</h2>
  <p><code>gepolymaskgen</code> is a new low-level GEE Fusion Pro tool capable of creating a mask file for a single source image, mosaicked source imagery set, or a GEE Fusion Pro imagery resource based on user-specified masking options. With this tool, users can programmatically create masks for imagery that follow a shoreline, create masks at a fixed feather value, or augment mask files with KML polygons from Google Earth to show or hide imagery through a mask. The <code>gepolymaskgen</code> tool has two key differences from the existing automask tool <code>gemaskgen</code>: 1) <code>gepolymaskgen</code> only fulfills operations specified by users and does not operate automatically in the same manner as <code>gemaskgen</code>; 2) <code>gepolymaskgen</code> may only be invoked by the command line, separately from the normal automated GEE resource import sequences.</p>
  <hr/>
  <h2><a id="h.q755la-khb6k2" name="h.q755la-khb6k2"></a>What is gemaskgen?</h2>
  <p><code>gemaskgen</code> is an existing low-level masking tool bundled with GEE Fusion Pro that is invoked by Fusion when building an imagery or terrain resource. The <code>gemaskgen</code> tool was designed to automatically build mask files for imported source imagery and terrain data to hide external, or internal, fill data from view on the globe. In order to build the mask, users must specify within the Resource Editing tool: which band (Red, Green, or Blue) should be used to create the mask; the amount of feathering that should be applied between the fill data (masked) and the usable imagery; a tolerance value (buffer) that may be applied by the tool when checking if a pixel is fill value or not; if the entire image should be checked for fill data (holes); and if both white and black fill data should be included in the mask (0 is assumed default, 255 to be included). </p>
  <p>The <code>gemaskgen</code> tool will be invoked by GEE Fusion Pro after the source imagery are converted into Fusion format (<code>kip</code>). <code>gemaskgen</code> collects the value for each corner pixel on band 1 of the image resource - which is assumed to be the fill data pixel value (0 is the typical value) - and then systematically moves through the <code>kip</code> adding all fill data into the mask until non-fill data is found. The edge between the fill data and usable imagery is feathered based on the user-specified feather value (in pixels). The new GEE Fusion Pro imagery, or terrain, resource is comprised of both the imported source data and the computed mask file as demonstrated in the graphic below. </p>
  <p><img alt="Masked imagery diagram" src="../art/custom_masks/image10.jpg"/></p>
  <hr/>
  <h2><a id="h.72rojo-cole53" name="h.72rojo-cole53"></a>Useful information about gepolymaskgen</h2>
  <ul class="spaced-list">
    <li><code>gepolymaskgen</code> is a single-threaded low-level GEE Fusion command-line tool that may be manually invoked for building custom mask files for imagery or terrain data sets </li>
    <li>Operationally, <code>gepolymaskgen</code> is CPU intensive and <em>very</em> RAM intensive.
      <ul>
        <li>At least 16GB free RAM must be available on the machine to safely build custom masks with <code>gepolymaskgen</code></li>
      </ul>
    </li>
    <li>All mask files built by <code>gepolymaskgen</code> will be written out in <code>GeoTIFF</code> format </li>
    <li>Mask files will be written with complementary geographic coordinates and projection to the source data
      <ul>
        <li>All mask files, KML polygons, vector source files, and source imagery should be in the same projection for building custom masks</li>
        <li>Masks may be built for resources in Plate-Carre projection (EPSG:4326) or Mercator projection (EPSG:3857)</li>
      </ul>
    </li>
    <li><code>gepolymaskgen</code> can build a mask for one source file or many source files that are described with a <code>khvr</code> virtual raster text file </li>
    <li>Mask files built by <code>gepolymaskgen</code> will use 255 to show imagery and 0 to hide imagery
      <ul>
        <li>All new masks start as an image file with all pixels of value 0 - all imagery will be masked.</li>
        <li>Areas to hide (to be masked) will be set to pixel value 0</li>
        <li>The <code>--or_mask</code> masking operator will, typically, show more imagery for an area in the final mask</li>
        <li>The <code>--and_neg_mask</code> masking operator will, typically, hide more imagery for an area in the final mask</li>
      </ul>
    </li>
    <li>The final mask is built by subtracting and adding desired areas to hide or view by a sequence of operators</li>
  </ul>
  <div class="note"> <strong>Note: </strong> It is easy to create very high resolution masks with <code>gepolymaskgen</code>, to the point of pixel-by-pixel matching for the source imagery. Please check the overall raster size of your source imagery before creating a custom mask with <code>gepolymaskgen</code> as it is easy to create a custom mask that will be larger than the 2GB <code>GeoTIFF</code> file size limit. Please see <a href="#h.o23346-tgkrx4">Appendix C</a> for further information on calculating the overall size of a mask file. </div>
  <hr/>
  <h2><a id="h.dih5zm-ijmhsm" name="h.dih5zm-ijmhsm"></a>Useful information about gemaskgen</h2>
  <ul class="spaced-list">
    <li><code>gemaskgen</code> is a single-threaded low-level Fusion tool which is automatically called during image and terrain resource builds after the source imagery or terrain is imported. </li>
    <li>All mask files computed by <code>gemaskgen</code> will be written out in <code>GeoTIFF</code> format </li>
    <li><code>gemaskgen</code> scans through an imported imagery or terrain resource to:
      <ul>
        <li>identify the pixel value of each corner pixel, and </li>
        <li>erode inward into the image to mask out all pixels that have the same pixel value as the corner pixels</li>
      </ul>
    </li>
    <li><code>gemaskgen</code> will, by default, create an output mask file which is no more than 16,000 pixels on any one side.
      <ul>
        <li>This can lead to low resolution masks for high resolution data</li>
      </ul>
    </li>
    <li>Masks may be manually created by invoking <code>gemaskgen</code> directly!
      <ul>
        <li>Masks larger than 16,000 pixels may be created for large imagery resources with the <code>--maxsize </code>option</li>
        <li>Please see <a href="#h.p9e53m-jf2wqc">Appendix D</a> for additional details </li>
      </ul>
    </li>
  </ul>
  <hr/>
  <h2>Comparison of the gemaskgen and gepolymaskgen</h2>
<table class="nice-table">
  <tbody>
    <tr>
      <th>Capability</th>
      <th><code>gemaskgen</code></th>
      <th><code>gepolymaskgen</code></th>
    </tr>
    <tr>
      <td>Reads Fusion format imagery (.kip) and terrain (.ktp)</td>
      <td>Yes</td>
      <td>No</td>
    </tr>
    <tr>
      <td>Part of image resource import process</td>
      <td>Yes, for automask mode</td>
      <td>No</td>
    </tr>
    <tr>
      <td>Can read source file images including: <code>khvrs;<br/>
        GeoTIFFs;<br/>
        JPEG2000</code></td>
      <td>No, can only read Fusion imagery and terrain resource formats</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td>Can automatically identify and mask Fill Data automatically within imagery resource (holes)</td>
      <td>Yes</td>
      <td>No, but may be manually removed with KML polygons</td>
    </tr>
    <tr>
      <td>Can feather a specified amount of pixels from the edge of the image, irrespective of the imagery pixel values</td>
      <td>No</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td>Capable of creating high resolution mask files</td>
      <td>Yes, manually possible</td>
      <td>Yes - depends on raster dimensions of input source file</td>
    </tr>
    <tr>
      <td>Can automatically distinguish Fill Data from usable imagery by pixel values</td>
      <td>Yes</td>
      <td>No</td>
    </tr>
    <tr>
      <td>Can mask out arbitrary polygonal shapes within the image resource</td>
      <td>No</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>
<hr/>
<h2><a id="h.15mqi8-ulnwei" name="h.15mqi8-ulnwei"></a>When to use gepolymaskgen</h2>
<p>The <code>gepolymaskgen</code> tool is best suited for when imagery is to be masked along specific, designated borders - such as coastlines, boundaries, or a building - or to mask image at a fixed feathering from the image edge regardless whether usable imagery or fill data are at the edge.</p>
<hr/>
<h2><a id="h.fwos0-p5skhq" name="h.fwos0-p5skhq"></a>When to use gemaskgen</h2>
<p>Fusion's automask (<code>gemaskgen</code>) function is best suited for automatically creating mask files that detect and hide fill data while displaying usable (non-fill) imagery. <code>gemaskgen</code> is also very useful when working with large image resources to create a base mask that will be less than 2GB in file size but still facilitate a high fidelity mask. </p>
<p>Please see <a href="#h.3wwhdu-olys6q">Appendix F</a> for further instructions on how <code>gemaskgen</code> may be utilized with creating masks for large image resources.</p>
<hr/>
<h2><a id="h.3zfe5m-jk46gp" name="h.3zfe5m-jk46gp"></a>Recommended tools for creating custom mask files</h2>
<ul class="spaced-list">
  <li>A server or workstation with minimum 16GB RAM to build the custom masks. More RAM is better!</li>
  <li>Global coastlines as polygons for coastline masking. <em>Make certain these are polygons and not lines</em></li>
  <li>A GIS application, such as QGIS, to view source imagery datasets. This is helpful in determining if usable imagery are surrounded by fill data, reprojecting the source imagery, or combining multiple source files into one image.</li>
  <li>A copy of Google Earth EC to connect to and view 3D databases built with the custom masks for QA testing. Google Earth can also be used in the masking process by creating KML polygons for additional areas that are to be masked from view. </li>
  <li>A photo editing application such as Adobe Photoshop, GIMP, or similar, to view the custom mask files after <code>gepolymaskgen</code> builds, or to make modifications to the mask file such as unmasking water bodies or exposing more visible water from a coastline.</li>
</ul>
<hr/>
<h2><a id="h.wlmas2-m402u4" name="h.wlmas2-m402u4"></a>gepolymaskgen command usage</h2>
<p><code>gepolymaskgen</code> has a few command line parameters to specify the workflow for creating a mask. The main workflow is directing <code>gepolymaskgen</code> to create or load an image as a reference for masking, generating as mask based on desired regions, feathering the mask edges as needed, and then writing out the resulting mask. Here are the main <code>gepolymaskgen</code> options:</p>
<p><code>gepolymaskgen</code></p>
<ol class="spaced-list">
  <li><strong>Specify which file to reference for creating the mask, or which existing mask file to load:</strong>
    <ul class="spaced-list">
      <li><strong><code>--base_image</code></strong>: specifies a source file that will be used for overall raster dimensions, geographic coordinates, and projection information. May be a <code>GeoTIFF</code>, <code>JPEG2000</code>, or <code>KHVR</code> file. Each <code>gepolymaskgen</code> invocation may only include either one <code>--base_image</code> or one <code>--base_mask</code> for masking operations. <br/>
      </li>
      <li><strong><code>--base_mask</code></strong>: specifies a mask file to read in for further mask processing. The specified file may be a <code>GeoTIFF</code>. Each <code>gepolymaskgeninvocation</code> may only include either one <code>--base_image</code> or one <code>--base_mask </code>for masking operations.</li>
    </ul>
  </li>
  <li><strong>Modify the mask file by changing what is masked and feathering:</strong>
    <ul class="spaced-list">
      <li><strong><code>--feather</code></strong>: directs <code>gepolymaskgen</code> to create a feather along a masked edge by the specified number of pixels. Either positive or negative values may be specified with <code>--feather</code> to expand or contract the feathered edge around the masked line. Positive feather settings typically erode into the usable imagery from the mask line (contracting) while negative feather settings typically erode away from the usable imagery from the mask line (expanding). Using the <code>--invert</code> setting with a masking operation will reverse the effect a <code>--feather</code> operation has on the mask. The <code>--feather</code> option may be used with the <code>--base_image</code>, <code>--base_mask</code>, <code>--and_neg_mask</code>, and <code>--or_mask</code> mask options; however, only one <code>--feather</code> option may be specified for each operator. The default feather value for <code>--feather</code> is set to 0 pixels.</li>
    </ul>
    <ul>
      <li><strong><code>--feather_border</code></strong>: used in conjunction only with <code>--feather</code>, and directs <code>gepolymaskgen</code> to apply a feather to the extent of the mask file with the same feathering values specified with the <code>--feather</code> option. The <code>--feather_border</code> option is off by default.</li>
    </ul>
    <ul class="spaced-list">
      <li><strong><code>--invert</code>:</strong> directs <code>gepolymaskgen</code> to invert a specified mask from its original values to the opposite. In almost all cases, this involves swapping pixel values from 0 to 255 or 255 to 0, depending on whether the <code>--base_image</code> or <code>--base_mask</code> are inverted, or a <code>--and_neg_mask</code> or<code>--or_mask</code> are inverted. Inverting a mask affects the <code> --feather</code> operations as well for expanding or contracting mask feather at the specified mask edges. The <code>--invert</code> option may be combined with <code>--base_image</code>, <code>--base_mask</code>, <code>--and_neg_mask</code>, <code>--or_mask</code>, or <code>--output_mask</code>. </li>
    </ul>
    <ul class="spaced-list">
      <li><strong><code>--and_neg_mask</code></strong>: directs <code>gepolymaskgen</code> to remove a specified area from view (i.e. subtracting, or masking). May be combined with the<code> --feather</code> and <code>--feather_border</code> options to build a feathered edge along masked areas. Multiple <code>--and_neg_mask </code>operations may be combined in one <code>gepolymaskgen</code> sequence as necessary for complex mask builds. It is possible to also possible for a <code>gepolymaskgen </code>sequence to include both<code> --and_neg_mask</code> and <code>--or_mask</code> operations.</li>
      <li><strong><code>--or_mask</code></strong>: directs <code>gepolymaskgen</code> to add a specified area into view (i.e. adding, or "unmasking"). May be combined with the <code>--feather</code> and <code>--feather_border</code> options to build a feathered edge along masked areas. Multiple<code> --or_mask</code> operations may be combined in one <code>gepolymaskgen</code> sequence, as necessary, for complex mask builds. It is also possible for a <code>gepolymaskgen</code> sequence to include both <code>--and_neg_mask</code> and <code>--or_mask </code>operations. </li>
    </ul>
  </li>
  <li><strong>Specify the output mask</strong>
    <ul class="spaced-list">
      <li><strong><code>--output_mask</code></strong>: the folder path location and filename <code>gepolymaskgen</code> is to write the finished mask file. The completed mask file to import with GEE Fusion Pro must have the same filename as the source file with a <code>-mask.tif</code> extension. For example, if the source file is <code>brazil-squareimage-nofill.tif</code> the mask file must be named <code>brazil-squareimage-nofill-mask.tif</code>. Only one <code>--output_mask</code> may be specified per <code>gepolymaskgen </code>operation.</li>
    </ul>
    <p>As an example, this <code>gepolymaskgen</code> invocation will create a zero-feather mask file that edge-matches source data:</p>
    <p><code>gepolymaskgen --feather 0 --feather_border 0 --base_image brazil-squareimage-nofill.khvr --invert --output_mask brazil-squareimage-nofill-mask.tif</code></p>
    <p>Let's step through the sequence of events that occur when <code>gepolymaskgen</code> is invoked as noted above. A new mask file will be created with the same raster dimensions, projection, and geographic coordinates as the <code>brazil-squareimage-nofill.khvr</code> mosaic file specified with <code>--base_image</code>. <code>gepolymaskgen</code> will not feather the edge of the new mask file (<code>--feather 0</code>) for which all pixel values in the mask will be 0.</p>
    <p> The <code>--invert</code> option directs <code>gepolymaskgen</code> to change the mask pixel values from 0 to 255 before writing out the finished mask file <code>brazil-squareimage-nofill-mask.tif</code>. The resulting mask file will look like the image below as viewed in the GIMP photo editing tool. The resulting image resource, when imported into GEE Fusion Pro will display all pixels since the mask file includes edge-to-edge 255 pixels, to display the imagery. Conversely, if all pixels were value 0 (black), the image would be fully hidden from view.</p>
    <h4>An edge-matched, zero-feather mask file built by gepolymaskgen as viewed in the GIMP photo editing tool: </h4>
    <p><img alt="Hidden masked diagram" src="../art/custom_masks/image24.jpg"/></p>
    <p>All custom mask files can be built with the different <code>gepolymaskgen</code> masking operators in various combinations to add or subtract shapes from a mask so only the desired imagery is visible. Some masking situations may be very complex and require building multiple mask files with <code>gepolymaskgen</code> to achieve the desired effect. The next section includes some common use cases for building custom masks as a quick reference guide so you may see the steps involved and copy and adapt the commands to suit your own masking needs. These example cases include creating an edge-matched imagery mask with no feathering; creating a mask that clips imagery to the coastline on one side and creates and edge feather on the other side; masking islands to only show land imagery; masking sections within an image. </p>
  </li>
</ol>
<hr/>
<h2><a id="h.3x0ypw-108xde" name="h.3x0ypw-108xde"></a>Example use cases and commands to build custom masks </h2>
<p>Five example cases are available below to reference for building custom masks for imagery resources within Google Earth Enterprise Fusion Pro. Each case, or scenario, is intended to address common masking challenges that may be encountered when working with various source imagery data sets. Each case will include contextual information for the scenario, workflow description, an example build with screenshots, and a set of command templates that may be copied and pasted to the command line of your system for building a custom mask. </p>
<p>The example cases include:</p>
<p><strong>Case 1</strong>: Creating masks for imagery that has edge-to-edge usable imagery pixels with a fixed-width feather;</p>
<p><strong>Case 2: </strong>Creating custom masks for islands with coastlines;</p>
<p><strong>Case 3</strong>: Creating a custom mask with coastlines on one side and a fixed-width feather on other sides; </p>
<p><strong>Case 4</strong>: Custom masks that mask out areas within the image utilizing a <code>KML</code> file;</p>
<p><strong>Case 5</strong>: Create a custom mask utilizing <code>gemaskgen</code> for automatic fill detection and <code>gepolymaskgen</code> for coastline masking</p>
<hr/>
<h3><a id="h.qszedw-11begv" name="h.qszedw-11begv"></a>Case 1: Create custom masks for imagery which has no fill pixels (usable imagery goes to the edges)</h3>
<p>Working with source imagery which fully includes usable imagery to the image edges can cause problems for the <code>gemaskgen</code> tool since usable imagery pixels (ex: 132, 56, 200), and not fill pixels (ex: 0,0,0), will occupy the image corners which <code>gemaskgen</code> references for fill pixel values. The <code>gepolymaskgen</code> tool is well suited to meet this masking challenge since a mask can be created the exact raster dimensions of the image resource, the exact feathering value (0) can be specified, and <code>gepolymaskgen</code> will not attempt to read pixel values. Consider the imagery mosaic below in the middle of Brazil which includes several source images which include all usable imagery and no fill. </p>
<h4>Location of image mosaic as seen with virtual raster file:</h4>
<p><img alt="Brazil Imagery mosaic diagram" src="../art/custom_masks/image29.jpg"/></p>
<h4>Close up of imagery resource imported into Fusion:</h4>
<p><img alt="Brazil Imagery Fusion import" src="../art/custom_masks/image40.jpg"/></p>
<p>Since we know the source imagery does not contain fill data we can create a custom mask based on the <code>khvr</code> virtual mosaic description file, then include this for import into Fusion. For this process, <code>gepolymaskgen</code> will need to know:</p>
<ol>
  <li>The base image to create the mask file from (including location and raster dimensions)</li>
  <li>What feather to apply to the image</li>
  <li>If the image border is to be feathered (yes)</li>
  <li>What to name the output image. </li>
</ol>
<p>Due to how <code>gepolymaskgen</code> works, we will have to invert the output mask so the image edge is masked out instead of masking out the usable imagery. A <code>khvr</code> mosaic description file was created for the collection of <code>JPEG2000</code> imagery files with the <code>gevirtualraster</code> command, and this will be used as our base image since it represents the overall size of the mosaic. The output mask will be named the same filename as the <code>khvr</code> file but with a <code>-mask.tif</code> extension so it may be read into Fusion Pro. Two masks will be built for this case which are identical except for the applied feathering value. Part 1 will build an edge-matched mask with a zero-edge feather to show all pixels of the source imagery while Part 2 will build an edge-matched mask with a 100-pixel feather.</p>
<h4><a id="h.mbcmn2-1t1ovi" name="h.mbcmn2-1t1ovi"></a>Example A: Creating an edge-matched mask with no feather</h4>
<p>The <strong>command template</strong> to build a zero-feather, edge-matched mask file with <code>gepolymaskgen</code> is: </p>
<p><code>gepolymaskgen --feather 0 --feather_border 0 --base_image imagery.tif --invert --output_mask imagery-mask.tif</code></p>
<p>Here is output from the console building a working mask file for the example imagery: </p>
<p><code>jcain@machine123:/gevol-local/src/$ time /opt/google/bin/gepolymaskgen --feather 0 --feather_border 0 --base_image brazil-squareimage-nofill.khvr --invert --output_mask brazil-squareimage-nofill-mask.tif</code></p>
<p><code>Fusion Notice: Feather 0</code></p>
<p><code>Fusion Notice: Feather border 0</code></p>
<p><code>Fusion Notice: Base image: brazil-squareimage-nofill.khvr</code></p>
<p><code>Fusion Notice: brazil-squareimage-nofill.khvr width: 20480 height: 20480</code></p>
<p><code>Fusion Notice: north: -7.646484e+00 south: -9.404297e+00 east: -5.387695e+01 west: -5.563477e+01</code></p>
<p><code>Fusion Notice: File type: KHM/Keyhole Mosaic</code></p>
<p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
<p><code>Fusion Notice: Invert</code></p>
<p><code>Fusion Notice: Output mask: brazil-squareimage-nofill-mask.tif</code></p>
<p><code>Fusion Notice: Setting feather 0.</code></p>
<p><code>Fusion Notice: Feather border is off.</code></p>
<p><code>Fusion Notice: Setting base image brazil-squareimage-nofill.khvr.</code></p>
<p><code>Fusion Notice: Inverting current mask.</code></p>
<p><code>Fusion Notice: Saving mask to brazil-squareimage-nofill-mask.tif.</code></p>
<p><code>Fusion Notice: Writing alpha file brazil-squareimage-nofill-mask.tif</code></p>
<p><code>real 0m5.350s</code></p>
<p><code>user 0m2.670s</code></p>
<p><code>sys 0m2.260s</code></p>
<p>The resulting mask will be approximately 100MB in filesize and will display all usable imagery in the areas of white pixels. </p>
<h4> View of the built mask file within the GIMP photo editing tool with edge-to-edge display of all imagery pixels for the source file:</h4>
<p><img alt="hidden masked diagram" src="../art/custom_masks/image24.jpg"/></p>
<h4>View of the image resource after import into Fusion Pro with the custom mask:</h4>
<p><img alt="Fusion Pro with custom mask" src="../art/custom_masks/image00.jpg"/></p>
<p>Once the mask file is built by <code>gepolymaskgen</code>, the source imagery may be imported into Fusion Pro by enabling the <code>havemask</code> masking mode in the Fusion GUI or specifying the <code>--havemask</code> option with the <code>genewimageryresource</code> or <code>gemodifyimageryresource</code> commands. </p>
<p>Please see <a href="#h.wwsxau-f5geku">Appendix A</a> for further information about enabling the <code>havemask</code> mask mode for an image resource.</p>
<h4><a id="h.iwshjk-8eno4v" name="h.iwshjk-8eno4v"></a>Example B: Creating an edge-matched mask with a fixed value feather </h4>
<p>The same technique described in Part 1 may also be used for creating a mask that masks the imagery edge by a specified number of pixels regardless of the imagery along the edges of the image. In this case, suppose we have the same 15-meter resolution imagery for Brazil from Part 1, where each source image includes usable imagery in each pixel and does not include any fill data borders, and we wish to create a mask for the entire mosaic that feathers 100 pixels into the image.</p>
<p>The <strong>command template </strong>to build a 100-pixel feathered edge mask is: </p>
<p><code>gepolymaskgen --feather -100 --feather_border 1 --base_image source-image.tif --invert --output_mask source-image-mask.tif</code></p>
<p>The pixel value may be larger than 100 pixels or smaller than 100 pixels to expand the mask into the imagery or toward the imagery edge as desired for each image and terrain resource. </p>
<p>Here is an example output from g<code>epolymaskgen</code> building the 100-pixel feather edge-matched mask for the Brazil imagery:</p>
<p><code>jcain@machine123:/gevol-local/src/$ time /opt/google/bin/gepolymaskgen --feather -100 --feather_border 1 --base_image brazil-squareimage-nofill.khvr --invert --output_mask brazil-squareimage-nofill-mask.tif</code></p>
<p><code>Fusion Notice: Feather -100</code></p>
<p><code>Fusion Notice: Feather border 1</code></p>
<p><code>Fusion Notice: Base image: brazil-squareimage-nofill.khvr</code></p>
<p><code>Fusion Notice: brazil-squareimage-nofill.khvr width: 20480 height: 20480</code></p>
<p><code>Fusion Notice: north: -7.646484e+00 south: -9.404297e+00 east: -5.387695e+01 west: -5.563477e+01</code></p>
<p><code>Fusion Notice: File type: KHM/Keyhole Mosaic</code></p>
<p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
<p><code>Fusion Notice: Invert</code></p>
<p><code>Fusion Notice: Output mask: brazil-squareimage-nofill-mask-100feather.tif</code></p>
<p><code>Fusion Notice: Setting feather -100.</code></p>
<p><code>Fusion Notice: Feather border is on.</code></p>
<p><code>Fusion Notice: Setting base image brazil-squareimage-nofill.khvr.</code></p>
<p><code>Total tiles to process: 1</code></p>
<p><code>Completed 100% (1/1) - tiles/sec: 0.10 - time left: 00:00:00 [CPU: 99 Mem: 975 MB PF: 0]</code></p>
<p><code>Processed 1 tiles</code></p>
<p><code>Total time to process: 00:00:10</code></p>
<p><code>Average tiles per second: 0.10</code></p>
<p><code>Fusion Notice: Inverting current mask.</code></p>
<p><code>Fusion Notice: Saving mask to brazil-squareimage-nofill-mask.tif.</code></p>
<p><code>Fusion Notice: Writing alpha file brazil-squareimage-nofill-mask.tif</code></p>
<p><code>real 0m16.985s</code></p>
<p><code>user 0m14.450s</code></p>
<p><code>sys 0m2.200s</code></p>
<p>The resulting mask file will be approximately 100MB in filesize with a feathered edge 100 pixels from the edge inwards into the image resource.</p>
<h4> Resulting mask file from gepolymaskgen seen in the GIMP photo editing tool: </h4>
<p><img alt="gepolymaskgen in gimp photo editor" src="../art/custom_masks/image31.jpg"/></p>
<h4>The image resource now has a 100-pixel feather after Fusion import:</h4>
<p><img alt="image with 100-pixel feather in Fusion" src="../art/custom_masks/image21.jpg"/></p>
<p>Once the mask file is built by <code>gepolymaskgen</code>, the source imagery may be imported into Fusion Pro by enabling the <code>havemask</code> masking mode in the Fusion GUI or specifying the <code>--havemask</code> option with the <code>genewimageryresource</code> or <code>gemodifyimageryresource</code> commands. </p>
<p>Please see <a href="#h.wwsxau-f5geku">Appendix A</a> for further information about enabling the <code>havemask</code> mask mode for an image resource.</p>
<hr/>
<h3><a id="h.3n4rc-ctite1" name="h.3n4rc-ctite1"></a>Case 2: Create custom masks for islands</h3>
<p>Masking imagery around islands is another good use case for <code>gepolymaskgen</code> since it is often desirable to only show usable imagery for the island above sea level and to mask imagery at the coastlines. In this example, we have imagery for the island of Oahu for Hawaii, USA, where all imagery for the island is to be seen in the imagery project but all imagery from the coastline away from the island to the edge of the imagery is to be masked from view. </p>
<h4> Fusion Preview window:</h4>
<p><img alt="Fusion preview window" src="../art/custom_masks/image02.jpg"/></p>
<p>The Fusion Preview window above displays the overall dimensions and source file extents for four images creating an imagery mosaic for the island of Oahu, Hawaii, USA. A virtual raster description file (<code>KHVR</code>) was created for the four source files and loaded into the Fusion Preview window.</p>
<h4> Importing the source imagery into Fusion Pro creates an image resource with imagery for the island and water (automask used):</h4>
<p><img alt="Island and water automask in Fusion" src="../art/custom_masks/image11.jpg"/></p>
<p>Four <code>JPEG2000</code> images were grouped into one virtual mosaic for the image resource and a <code>khvr</code> mosaic description file was built with <code>gevirtualraster</code>. To create the custom mask we need to:</p>
<ol class="spaced-list">
  <li>Direct <code>gepolymaskgen</code> to use the source <code>khvr</code> file as the base image to set the custom mask the same raster size and fully masks all imagery from view;</li>
  <li>Clip out the island of Oahu with a set of vector polygons so the island imagery will be visible;</li>
  <li>Feather along the specified polygon coastlines to facilitate smooth blending with other image resources (feather = 100);</li>
  <li>Write out the custom mask file.</li>
</ol>
<p>Two examples will be included for this case demonstrating the effect of positive and negative feather values for feathering along the shoreline. Generally speaking, a positive feather value will erode from the mask line inward to show less visible imagery while a negative feather value will draw away from the mask line to show more visible imagery.</p>
<h4><a id="h.y33yje-634qnl" name="h.y33yje-634qnl"></a>Example A: Create a custom edge-matched mask for an island that masks into the land</h4>
<p>The <strong>command template</strong> for creating a custom mask for an island with a positive value feather is: </p>
<p><code>gepolymaskgen --base_image imagery.tif --feather 100 --or_mask world_coastlines_4326.shp --output_mask imagery-mask.tif</code></p>
<p>The larger or smaller pixel value may be specified to expand the mask further from the coastline into the visible imagery (larger number), or to stay closer to the coastline.</p>
<p> Example console output is included below:</p>
<p><code>jcain@machine123:/gevol-local/src/gepolymaskgen-howto$ time gepolymaskgen --base_image glandsat_15m_oahu.khvr --feather 100 --or_mask world_coastlines_4326.shp --output_mask glandsat_15m_oahu-100mask.tif</code></p>
<p><code>Fusion Notice: Base image: glandsat_15m_oahu.khvr</code></p>
<p><code>Fusion Notice: glandsat_15m_oahu.khvr width: 10240 height: 10240</code></p>
<p><code>Fusion Notice: north: 2.179688e+01 south: 2.091797e+01 east: -1.575879e+02 west: -1.584668e+02</code></p>
<p><code>Fusion Notice: File type: KHM/Keyhole Mosaic</code></p>
<p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
<p><code>Fusion Notice: Feather 100</code></p>
<p><code>Fusion Notice: OR mask: world_coastlines_4326.shp</code></p>
<p><code>Fusion Notice: Output mask: glandsat_15m_oahu-100mask.tif</code></p>
<p><code>Fusion Notice: Setting base image glandsat_15m_oahu.khvr.</code></p>
<p><code>Fusion Notice: Setting feather 100.</code></p>
<p><code>Fusion Notice: Writing alpha file glandsat_15m_oahu-100mask.tif</code></p>
<p><code>Fusion Notice: Executing: gdal_rasterize -b 1 -burn 255 -l world_coastlines_4326 world_coastlines_4326.shp glandsat_15m_oahu-100mask.tif</code></p>
<p><code>0...10...20...30...40...50...60...70...80...90...100 - done.</code></p>
<p><code>Total tiles to process: 1</code></p>
<p><code>Completed 100% (1/1) - tiles/sec: 0.38 - time left: 00:00:00 [CPU: 15 Mem: 554 MB PF: 0]</code></p>
<p><code>Processed 1 tiles</code></p>
<p><code>Total time to process: 00:00:03</code></p>
<p><code>Average tiles per second: 0.38</code></p>
<p><code>Fusion Notice: OR-ing mask with new mask.</code></p>
<p><code>Fusion Notice: Saving mask to glandsat_15m_oahu-100mask.tif.</code></p>
<p><code>Fusion Notice: Writing alpha file glandsat_15m_oahu-100mask.tif</code></p>
<p><code>real 0m31.757s</code></p>
<p><code>user 0m28.390s</code></p>
<p><code>sys 0m3.020s</code></p>
<p>The resulting mask file is approximately 400MB in filesize. Screenshots of the output mask and resulting Fusion image resource may be seen below.</p>
<h4>View of the mask with a 100 pixel feather as seen in the GIMP photo editor:</h4>
<p><img alt="Mask with 100 pixel feather in GIMP" src="../art/custom_masks/image09.jpg"/></p>
<h4>View of the Oahu, Hawaii, USA imagery in Fusion Preview after importing the custom mask with the image resource:</h4>
<p><img alt="Custom" fusion="fusion" hawiai="Hawiai" in="in" mask="mask" oahu="Oahu" of="of" src="../art/custom_masks/image33.jpg"/></p>
<p>The custom mask file may now be imported into Fusion Pro with the source imagery by enabling the <code>havemask</code> masking mode in the Fusion Pro Resource Editor or by specifying the <code>gemodifyimageryresource --havemask</code> option on the command line. </p>
<p>Please see <a href="#h.wwsxau-f5geku">Appendix A</a> for further information about enabling the <code>havemask</code> mask mode for an image resource.</p>
<h4><a id="h.o53yvg-84blkd" name="h.o53yvg-84blkd"></a>Example B: Create a custom edge-matched mask for an island that masks into the water</h4>
<p>This example uses the same source imagery as <a href="#h.y33yje-634qnl">Example A</a> but a negative pixel value is provided for the feather value to expand the mask feather away from the shoreline outward into the water. </p>
<p>The <strong>command template</strong> for this example is:</p>
<p> <code>gepolymaskgen --base_image imagery.khvr --feather -100 --or_mask world_coastlines_4326.shp --output_mask imagery-mask.tif</code></p>
<p>Larger or smaller negative feather values may be specified with the <code>gepolymaskgen </code>command to expand farther away from the coastline mask or closer to the coastline mask as desired.</p>
<p> Example output for creating the mask and screenshots are included below: </p>
<p><code>jcain@machine123:/gevol-local/src/gepolymaskgen-howto$ time gepolymaskgen --base_image glandsat_15m_oahu.khvr --feather -100 --or_mask world_coastlines_4326.shp --output_mask glandsat_15m_oahu-minus100mask.tif</code></p>
<p><code>Fusion Notice: Base image: glandsat_15m_oahu.khvr</code></p>
<p><code>Fusion Notice: glandsat_15m_oahu.khvr width: 10240 height: 10240</code></p>
<p><code>Fusion Notice: north: 2.179688e+01 south: 2.091797e+01 east: -1.575879e+02 west: -1.584668e+02</code></p>
<p><code>Fusion Notice: File type: KHM/Keyhole Mosaic</code></p>
<p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
<p><code>Fusion Notice: Feather -100</code></p>
<p><code>Fusion Notice: OR mask: world_coastlines_4326.shp</code></p>
<p><code>Fusion Notice: Output mask: glandsat_15m_oahu-minus100mask.tif</code></p>
<p><code>Fusion Notice: Setting base image glandsat_15m_oahu.khvr.</code></p>
<p><code>Fusion Notice: Setting feather -100.</code></p>
<p><code>Fusion Notice: Writing alpha file glandsat_15m_oahu-minus100mask.tif</code></p>
<p><code>Fusion Notice: Executing: gdal_rasterize -b 1 -burn 255 -l world_coastlines_4326 world_coastlines_4326.shp glandsat_15m_oahu-minus100mask.tif</code></p>
<p><code>0...10...20...30...40...50...60...70...80...90...100 - done.</code></p>
<p><code>Total tiles to process: 1</code></p>
<p><code>Completed 100% (1/1) - tiles/sec: 0.38 - time left: 00:00:00 [CPU: 16 Mem: 554 MB PF: 0]</code></p>
<p><code>Processed 1 tiles</code></p>
<p><code>Total time to process: 00:00:03</code></p>
<p><code>Average tiles per second: 0.38</code></p>
<p><code>Fusion Notice: OR-ing mask with new mask.</code></p>
<p><code>Fusion Notice: Saving mask to glandsat_15m_oahu-minus100mask.tif.</code></p>
<p><code>Fusion Notice: Writing alpha file glandsat_15m_oahu-minus100mask.tif</code></p>
<p><code>real 0m31.621s</code></p>
<p><code>user 0m28.510s</code></p>
<p><code>sys 0m3.100s</code></p>
<p>The resulting mask file is approximately 400MB in filesize. Screenshots of the output mask and resulting Fusion image resource may be seen below.</p>
<h4>View of the mask file with a -100 pixel feather as seen in the GIMP photo editor:</h4>
<p><img alt="Mask file of Oahu Hawaii in GIMP" src="../art/custom_masks/image34.jpg"/></p>
<h4>View of the Oahu, Hawaii, USA imagery in Fusion Preview after importing the custom mask with the image resource:</h4>
<p><img alt="Oahu Hawaii in Fusion Preview" src="../art/custom_masks/image28.jpg"/></p>
<p>The custom mask file may now be imported into Fusion Pro with the source imagery by enabling the <code>havemask</code> masking mode in the Fusion Pro Resource Editor or by specifying the <code>gemodifyimageryresource --havemask</code> option on the command line.</p>
<p>Please see <a href="#h.wwsxau-f5geku">Appendix A</a> for further information about enabling the <code>havemask</code> mask mode for an image resource.</p>
<hr/>
<h3><a id="#h.bx3u98-pvlwqy" name="#h.bx3u98-pvlwqy"></a>Case 3: Create custom masks with coastlines and shared edges with other imagery resources</h3>
<p>Creating custom masks for imagery resources bordering coastlines is a little more challenging since a set of vector polygons are needed to mask the desired imagery to the coastline, and it is necessary to determine what feather values to apply to the coastline and the external edges of the mask. Let's first see the imagery we will be working with in this example.</p>
<h4>View from the Fusion Preview GUI with imagery for California, USA along the coastline:</h4>
<p><img alt="Fusiin Preview GUI in California" src="../art/custom_masks/image41.jpg"/></p>
<p>Forty-two source files of 15-meter imagery have been grouped into one virtual raster to build a new imagery resource. The source images along the interior of California fully contain usable imagery and do not include fill data; however, imagery along the Pacific Ocean includes water. The goal will be to mask the water from view while displaying imagery for the land. The workflow will be as follows:</p>
<ol>
  <li>Create the overall mask for the image</li>
  <li>Apply a set of coastal polygons to demarcate the coastline</li>
  <li>Feather the coastline and apply the feather to the mask border as well</li>
  <li>Write out the mask file</li>
</ol>
<p>In this case, we will create three different types of masks with coastline data - one where the coastlines and edges have the same feathering, one where the coastlines and edges have different feathering values, and one where the coastline is feathered but the edges are not feathered. </p>
<h4><a id="h.frsdlq-dl14oj" name="h.frsdlq-dl14oj"></a>Example A: Create an edge-matched custom mask that feathers coastlines and external edges with the same feather value</h4>
<p>This example will build a mask file that masks visible imagery to a specified coastline polygon - described by a source vector file in <code>ESRI Shapefile format</code> - and hides all ocean imagery from view. The source data are comprised of 42 images in a rectangle with the northernmost and easternmost edges being a border for another image resource. A consistent feather value (300 pixels) will be applied to both the coastlines and the external edges of the imagery with <code>gepolymaskgen</code>. </p>
<p>The <strong>command template</strong> to build this type of mask is: </p>
<p><code>gepolymaskgen --base_image imagery.khvr --invert --feather -300 --feather_border 1 --and_neg_mask world_coastlines_4326.shp --invert --output_mask imagery-mask.tif</code></p>
<p>Here is an example output to build this type of mask for the 15-meter resolution California imagery:</p>
<p><code>jcain@machine123:/gevol-local/src/gepolymaskgen-howto$ time /opt/google/bin/gepolymaskgen --base_image glandsat_15m_california_bay_area.khvr --invert --feather -300 --feather_border 1 --and_neg_mask world_coastlines_4326.shp --invert --output_mask glandsat_15m_california_bay_area-coastline-exampleA.tif</code></p>
<p><code>Fusion Notice: Base image: glandsat_15m_california_bay_area.khvr</code></p>
<p><code>Fusion Notice: glandsat_15m_california_bay_area.khvr width: 35840 height: 30720</code></p>
<p><code>Fusion Notice: north: 3.849609e+01 south: 3.585938e+01 east: -1.211133e+02 west: -1.241895e+02</code></p>
<p><code>Fusion Notice: File type: KHM/Keyhole Mosaic</code></p>
<p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
<p><code>Fusion Notice: Invert</code></p>
<p><code>Fusion Notice: Feather -300</code></p>
<p><code>Fusion Notice: Feather border 1</code></p>
<p><code>Fusion Notice: AND mask: world_coastlines_4326.shp</code></p>
<p><code>Fusion Notice: Invert</code></p>
<p><code>Fusion Notice: Output mask: glandsat_15m_california_bay_area-coastline-exampleA.tif</code></p>
<p><code>Fusion Notice: Setting base image glandsat_15m_california_bay_area.khvr.</code></p>
<p><code>Fusion Notice: Inverting current mask.</code></p>
<p><code>Fusion Notice: Setting feather -300.</code></p>
<p><code>Fusion Notice: Feather border is on.</code></p>
<p><code>Fusion Notice: Writing alpha file glandsat_15m_california_bay_area-coastline-exampleA.tif</code></p>
<p><code>Fusion Notice: Executing: gdal_rasterize -b 1 -burn 255 -l world_coastlines_4326 world_coastlines_4326.shp glandsat_15m_california_bay_area-coastline-exampleA.tif</code></p>
<p><code>0...10...20...30...40...50...60...70...80...90...100 - done.</code></p>
<p><code>Total tiles to process: 1</code></p>
<p><code>Completed 100% (1/1) - tiles/sec: 0.04 - time left: 00:00:00 [CPU: 19 Mem: 3844 MB PF: 0]</code></p>
<p><code>Processed 1 tiles</code></p>
<p><code>Total time to process: 00:00:28</code></p>
<p><code>Average tiles per second: 0.04</code></p>
<p><code>Fusion Notice: AND-ing mask with new mask.</code></p>
<p><code>Fusion Notice: Inverting current mask.</code></p>
<p><code>Fusion Notice: Saving mask to glandsat_15m_california_bay_area-coastline-exampleA.tif.</code></p>
<p><code>Fusion Notice: Writing alpha file glandsat_15m_california_bay_area-coastline-exampleA.tif</code></p>
<p><code>real 3m55.820s</code></p>
<p><code>user 3m39.810s</code></p>
<p><code>sys 0m15.650s</code></p>
<p>The resulting mask file is approximately 1GB in filesize. Screenshot of the mask from the GIMP photo editing tool and the resulting image resource after the mask is applied are available below.</p>
<h4>View of the mask file built in Example A as seen in the GIMP photo editing tool:</h4>
<p><img alt="Example A mask file in GIMP" src="../art/custom_masks/image13.jpg"/></p>
<h4>View of the imagery resource within the Fusion Preview window after the custom mask is imported:</h4>
<p><img alt="Finished image after custom mask import" src="../art/custom_masks/image05.jpg"/></p>
<p>The custom mask file may now be imported into Fusion Pro with the source imagery by enabling the <code>havemask</code> masking mode in the Fusion Pro Resource Editor or by specifying the <code>gemodifyimageryresource --havemask</code> option on the command line. </p>
<p>Please see <a href="#h.wwsxau-f5geku">Appendix A</a> for further information about enabling the havemask mask mode for an image resource.</p>
<h4><a id="h.liqys0-bdy6ft" name="h.liqys0-bdy6ft"></a>Example B: Create an edge-matched custom mask with feathered coastlines and feathered external edges</h4>
<p>This example will build a mask file that masks visible imagery to a specified coastline polygon - described by a source vector file in <code>ESRI Shapefile</code> format - and hides all ocean imagery from view. The source data are comprised of 42 images in a rectangle with the northernmost and easternmost edges being a border for another image resource. A feather value of -300 pixels will be applied to the coastlines while a -100 pixel feather will be applied to the external imagery edges with <code>gepolymaskgen</code>. This use case is more complex in that three separate steps are needed to create twp separate masks - one which includes the feather border for the overall image, one for the coastlines - and then one operation to merge the mask files together. </p>
<p>The <strong>command templates</strong> are as follows:</p>
<ol class="spaced-list">
  <li><strong>Create a 'picture frame' mask for the overall image:</strong>
    <p> <code>gepolymaskgen --feather -100 --feather_border 1 --base_image source_image.tif --output_mask borderfeather-mask.tif</code></p>
  </li>
  <li><strong>Create a coastline mask:</strong>
    <p><code>gepolymaskgen --base_image source_image.tif --feather -300 --or_mask world_coastlines_4326.shp --output coastline-mask.tif</code></p>
  </li>
  <li><strong>Merge the two masks together into the final mask:</strong>
    <p><code>gepolymaskgen --base_mask coastline-mask.tif --and_neg_mask borderfeather-mask.tif --output_mask source_image-mask.tif</code></p>
  </li>
</ol>
<p>Screen shots of each mask file generated by the three steps are included below as a reference.</p>
<h4>Picture frame border mask:</h4>
<p><img alt="picture frame border mask" src="../art/custom_masks/image30.jpg"/></p>
<h4>Coastline mask:</h4>
<p><img alt="Example A mask file in GIMP" src="../art/custom_masks/image13.jpg"/></p>
<br/>
<h4>Finished, merged mask of coastline and border feather:</h4>
<p><img alt="finished mask of coastline and border feather" src="../art/custom_masks/image07.jpg"/></p>
<p>Console output for building these masks are included below for reference along with the time to build and output filesizes for each of the three masks.</p>
<ol class="spaced-list">
  <li><strong>Create a 'picture frame' mask for the overall image:</strong>
    <p><code>jcain@machine123:/gevol-local/src/gepolymaskgen-howto$ time gepolymaskgen --feather -100 --feather_border 1 --base_image glandsat_15m_california_bay_area.khvr --output_mask california_borderfeather-mask.tif</code></p>
    <p><code>Fusion Notice: Feather -100</code></p>
    <p><code>Fusion Notice: Feather border 1</code></p>
    <p><code>Fusion Notice: Base image: glandsat_15m_california_bay_area.khvr</code></p>
    <p><code>Fusion Notice: glandsat_15m_california_bay_area.khvr width: 35840 height: 30720</code></p>
    <p><code>Fusion Notice: north: 3.849609e+01 south: 3.585938e+01 east: -1.211133e+02 west: -1.241895e+02</code></p>
    <p><code>Fusion Notice: File type: KHM/Keyhole Mosaic</code></p>
    <p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
    <p><code>Fusion Notice: Output mask: california_borderfeather-mask.tif</code></p>
    <p><code>Fusion Notice: Setting feather -100.</code></p>
    <p><code>Fusion Notice: Feather border is on.</code></p>
    <p><code>Fusion Notice: Setting base image glandsat_15m_california_bay_area.khvr.</code></p>
    <p><code>Total tiles to process: 1</code></p>
    <p><code>Completed 100% (1/1) - tiles/sec: 0.04 - time left: 00:00:00 [CPU: 98 Mem: 2294 MB PF: 0]</code></p>
    <p><code>Processed 1 tiles</code></p>
    <p><code>Total time to process: 00:00:27</code></p>
    <p><code>Average tiles per second: 0.04</code></p>
    <p><code>Fusion Notice: Saving mask to california_borderfeather-mask.tif.</code></p>
    <p><code>Fusion Notice: Writing alpha file california_borderfeather-mask.tif</code></p>
    <p><code>real 0m40.672s</code></p>
    <p><code>user 0m36.000s</code></p>
    <p><code>sys 0m4.300s</code></p>
    <p>The resulting mask file is approximately 1GB in filesize. </p>
  </li>
  <li><strong>Create a coastline mask:</strong>
    <p><code>jcain@machine123:/gevol-local/src/gepolymaskgen-howto$ time gepolymaskgen --base_image glandsat_15m_california_bay_area.khvr --feather -300 --or_mask world_coastlines_4326.shp --output california_coastline-mask.tif</code></p>
    <p><code>Fusion Notice: Base image: glandsat_15m_california_bay_area.khvr</code></p>
    <p><code>Fusion Notice: glandsat_15m_california_bay_area.khvr width: 35840 height: 30720</code></p>
    <p><code>Fusion Notice: north: 3.849609e+01 south: 3.585938e+01 east: -1.211133e+02 west: -1.241895e+02</code></p>
    <p><code>Fusion Notice: File type: KHM/Keyhole Mosaic</code></p>
    <p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
    <p><code>Fusion Notice: Feather -300</code></p>
    <p><code>Fusion Notice: OR mask: world_coastlines_4326.shp</code></p>
    <p><code>Fusion Notice: Output mask: california_coastline-mask.tif</code></p>
    <p><code>Fusion Notice: Setting base image glandsat_15m_california_bay_area.khvr.</code></p>
    <p><code>Fusion Notice: Setting feather -300.</code></p>
    <p><code>Fusion Notice: Writing alpha file california_coastline-mask.tif</code></p>
    <p><code>Fusion Notice: Executing: gdal_rasterize -b 1 -burn 255 -l world_coastlines_4326 world_coastlines_4326.shp california_coastline-mask.tif</code></p>
    <p><code>0...10...20...30...40...50...60...70...80...90...100 - done.</code></p>
    <p><code>Total tiles to process: 1</code></p>
    <p><code>Completed 100% (1/1) - tiles/sec: 0.04 - time left: 00:00:00 [CPU: 19 Mem: 3844 MB PF: 0]</code></p>
    <p><code>Processed 1 tiles</code></p>
    <p><code>Total time to process: 00:00:28</code></p>
    <p><code>Average tiles per second: 0.04</code></p>
    <p><code>Fusion Notice: OR-ing mask with new mask.</code></p>
    <p><code>Fusion Notice: Saving mask to california_coastline-mask.tif.</code></p>
    <p><code>Fusion Notice: Writing alpha file california_coastline-mask.tif</code></p>
    <p><code>real 3m56.730s</code></p>
    <p><code>user 3m41.010s</code></p>
    <p><code>sys 0m15.340s</code></p>
    <p>The resulting mask file is approximately 1GB in filesize. </p>
  </li>
  <li><strong>Merge the two masks together into the final mask:</strong>
    <p><code>jcain@machine123:/gevol-local/src/gepolymaskgen-howto$ time gepolymaskgen --base_mask california_coastline-mask.tif --and_neg_mask california_borderfeather-mask.tif --output_mask glandsat_15m_california_bay_area-mask.tif</code></p>
    <p><code>Fusion Notice: Base mask: california_coastline-mask.tif</code></p>
    <p><code>Fusion Notice: california_coastline-mask.tif width: 35840 height: 30720</code></p>
    <p><code>Fusion Notice: north: 3.849609e+01 south: 3.585938e+01 east: -1.211133e+02 west: -1.241895e+02</code></p>
    <p><code>Fusion Notice: File type: GTiff/GeoTIFF</code></p>
    <p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
    <p><code>Fusion Notice: AND mask: california_borderfeather-mask.tif</code></p>
    <p><code>Fusion Notice: Output mask: glandsat_15m_california_bay_area-mask.tif</code></p>
    <p><code>Fusion Notice: Setting base mask california_coastline-mask.tif.</code></p>
    <p><code>Fusion Notice: Writing alpha file glandsat_15m_california_bay_area-mask.tif</code></p>
    <p><code>Fusion Notice: AND-ing mask with new mask.</code></p>
    <p><code>Fusion Notice: Saving mask to glandsat_15m_california_bay_area-mask.tif.</code></p>
    <p><code>Fusion Notice: Writing alpha file glandsat_15m_california_bay_area-mask.tif</code></p>
    <p><code>real 0m23.029s</code></p>
    <p><code>user 0m15.690s</code></p>
    <p><code>sys 0m7.300s</code></p>
    <p>The resulting mask file is approximately 1GB in filesize.</p>
    <h4>View of finished mask file feathering the coastlines and external edges of the image resource:</h4>
    <p><img alt="finished mask of coastline and border feather" src="../art/custom_masks/image07.jpg"/></p>
    <h4>View of finished image resource after importing custom mask:</h4>
    <p><img alt="Finished image after custom mask import" src="../art/custom_masks/image42.jpg"/></p>
    <p>The custom mask file may now be imported into Fusion Pro with the source imagery by enabling the <code>havemask</code> masking mode in the Fusion Pro Resource Editor or by specifying the <code>gemodifyimageryresource --havemask</code> option on the command line. </p>
    <p>Please see <a href="#h.wwsxau-f5geku">Appendix A</a> for further information about enabling the <code>havemask</code> mask mode for an image resource.</p>
  </li>
</ol>
<h4><a id="h.vwnw2u-5ziegd" name="h.vwnw2u-5ziegd"></a>Example C: Feathered internal coastline and no-feather external edge </h4>
<p>This example will build a mask file that masks visible imagery to a specified coastline polygon - described by a source vector file in <code>ESRI Shapefile</code> format - and hides all ocean imagery from view. The source data are comprised of 42 images in a rectangle with the northernmost and easternmost edges being a border for another image resource. A feather value (300 pixels) will be applied to the coastlines while the external imagery edges will have a zero-feather edge. </p>
<p>The <strong>command template</strong> for this mask is: </p>
<p><code>gepolymaskgen --base_image source_imagery.tif --invert --feather -300 --feather_border 0 --and_neg_mask world_coastlines_4326.shp --invert --output_mask source_imagery-mask.tif</code></p>
<p>Console output for building this mask is included below for reference:</p>
<p><code>jcain@machine123:/gevol-local/src/gepolymaskgen-howto$ time gepolymaskgen --base_image glandsat_15m_california_bay_area.khvr --invert --feather -300 --feather_border 0 --and_neg_mask world_coastlines_4326.shp --invert --output_mask glandsat_15m_california_bay_area-mask.tif</code></p>
<p><code>Fusion Notice: Base image: glandsat_15m_california_bay_area.khvr</code></p>
<p><code>Fusion Notice: glandsat_15m_california_bay_area.khvr width: 35840 height: 30720</code></p>
<p><code>Fusion Notice: north: 3.849609e+01 south: 3.585938e+01 east: -1.211133e+02 west: -1.241895e+02</code></p>
<p><code>Fusion Notice: File type: KHM/Keyhole Mosaic</code></p>
<p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
<p><code>Fusion Notice: Invert</code></p>
<p><code>Fusion Notice: Feather -300</code></p>
<p><code>Fusion Notice: Feather border 0</code></p>
<p><code>Fusion Notice: AND mask: world_coastlines_4326.shp</code></p>
<p><code>Fusion Notice: Invert</code></p>
<p><code>Fusion Notice: Output mask: glandsat_15m_california_bay_area-mask.tif</code></p>
<p><code>Fusion Notice: Setting base image glandsat_15m_california_bay_area.khvr.</code></p>
<p><code>Fusion Notice: Inverting current mask.</code></p>
<p><code>Fusion Notice: Setting feather -300.</code></p>
<p><code>Fusion Notice: Feather border is off.</code></p>
<p><code>Fusion Notice: Writing alpha file glandsat_15m_california_bay_area-mask.tif</code></p>
<p><code>Fusion Notice: Executing: gdal_rasterize -b 1 -burn 255 -l world_coastlines_4326 world_coastlines_4326.shp glandsat_15m_california_bay_area-mask.tif</code></p>
<p><code>0...10...20...30...40...50...60...70...80...90...100 - done.</code></p>
<p><code>Total tiles to process: 1</code></p>
<p><code>Completed 100% (1/1) - tiles/sec: 0.04 - time left: 00:00:00 [CPU: 19 Mem: 3844 MB PF: 0]</code></p>
<p><code>Processed 1 tiles</code></p>
<p><code>Total time to process: 00:00:28</code></p>
<p><code>Average tiles per second: 0.04</code></p>
<p><code>Fusion Notice: AND-ing mask with new mask.</code></p>
<p><code>Fusion Notice: Inverting current mask.</code></p>
<p><code>Fusion Notice: Saving mask to glandsat_15m_california_bay_area-mask.tif.</code></p>
<p><code>Fusion Notice: Writing alpha file glandsat_15m_california_bay_area-mask.tif</code></p>
<p><code>real 3m55.201s</code></p>
<p><code>user 3m40.410s</code></p>
<p><code>sys 0m14.540s</code></p>
<p>The resulting mask will be approximately 1GB in filesize.</p>
<h4>View of the finished mask within the GIMP photo editing tool:</h4>
<p><img alt="finished mask in GIMP" src="../art/custom_masks/image32.jpg"/></p>
<h4>View of the imagery resource within the Fusion Preview window after importing the custom mask:</h4>
<p><img alt="Fusion preview window with custom mark import" src="../art/custom_masks/image43.jpg"/></p>
<p>The custom mask file may now be imported into Fusion Pro with the source imagery by enabling the <code>havemask</code> masking mode in the Fusion Pro Resource Editor or by specifying the <code>gemodifyimageryresource --havemask</code> option on the command line. </p>
<p>Please see <a href="#h.wwsxau-f5geku">Appendix A</a> for further information about enabling the <code>havemask</code> mask mode for an image resource.</p>
<hr/>
<h3><a id="h.d2mv1m-pa0xwq" name="h.d2mv1m-pa0xwq"></a>Case 4: Masking out sections within an image resource</h3>
<p><code>gepolymaskgen</code> is capable of masking out sections within a source image in addition to masking external edges of the imagery. This is similar to the hole checking option with the <code>gemaskgen</code> tool which can automatically scan an image resource to seek fill data within the image resource. The main difference is <code>gepolymaskgen</code> will only mask out user-specified sections of the imagery. This example case will build on the principles discussed in <a href="#h.qszedw-11begv">Case 1</a> where a fixed feather value edge mask will be made for a mosaic with imagery to the edges, and additionally demonstrate removing (masking) internal portions of an image resource from view with a <code>KML</code> file created in Google Earth. Let's first see a screenshot of imagery used for this example.</p>
<h4>View of image resource in Fusion Preview after import with the automask tool:</h4>
<p><img alt="image in Fusion with automask" src="../art/custom_masks/image16.jpg"/></p>
<p>Boundaries for the imported source files (<code>khvr</code>) are overlayed on the image for reference.</p>
<p>The workflow for this example is different from the others since we need a <code>KML</code> file to specify which area in the image to remove from view. The general workflow will be:</p>
<ol class="spaced-list">
  <li>Import the imagery into GEE Fusion Pro and build into an imagery project</li>
  <li>Build and publish the imagery into a flyable 3D database</li>
  <li>View the 3D database with Google Earth EC to QA the data</li>
  <li>Draw an enclosed polygon in Google Earth EC that would mask the missing area of imagery from view</li>
  <li>Build the custom mask with <code>gepolymaskgen</code> to correctly feather the imagery edges and mask the missing imagery</li>
  <li>Import the custom mask with the image resource</li>
</ol>
<p>Examples of what the imagery resource looks like as viewed in Google Earth EC are included below.</p>
<h4>This image demonstrates how the image resource appears with the area of missing imagery: </h4>
<p><img alt="Missing imagery in GEEC" src="../art/custom_masks/image23.jpg"/></p>
<h4>This image is a screenshot after a polygon was drawn over the entire area of missing imagery:</h4>
<p><img alt="Polygon on mising imagery" src="../art/custom_masks/image03.jpg"/></p>
<p>The polygon area was set to 50% opacity in order to show the polygon fully covers the area of missing imagery with a little overlap into the usable imagery. This polygon will be stored in the <strong>Places</strong> panel of Google Earth EC and must be saved out from Google Earth as an independent <code>KML</code> file that can then be utilized with <code>gepolymaskgen</code>.</p>
<div class="note"> <strong>Note: </strong> Additional information about creating polygons within Google Earth is also freely available with the Google Earth Outreach tutorials, directly accessible at <a href="http://earth.google.com/outreach/tutorial_annotate.html#addpolygons">http://earth.google.com/outreach/tutorial_annotate.html#addpolygons</a>. </div>
<div class="tip"> <strong>Tip: </strong>Each polygon correction should be saved out as a <code>KML</code> file directly (four polygons saved to four separate <code>KML</code> files) as these will be separate mask operations within <code>gepolymaskgen</code>. </div>
<h4><a id="h.u7hsy2-gulr1j" name="h.u7hsy2-gulr1j"></a>Example A: Creating an edge-matched mask with a feathered edge and masking missing internal imagery in one step</h4>
<p>This example will create the custom mask in one command sequence by first creating a feathered edge mask based on the source image (<code>--base_image</code>) and then applying a <code>KML</code> file to mask out the area of missing imagery.</p>
<p>The <strong>command template</strong> to create the mask, in one step, is:</p>
<p> <code>gepolymaskgen --feather -100 --feather_border 1 --base_image source_imagery.khvr --invert --feather 50 --and_neg_mask missing-imagery-area.kml --output_mask source_imagery-mask.tif</code></p>
<p>Console output for creating the mask file in one step is as follows: </p>
<p><code>jcain@machine123:/gevol-local/src/gepolymaskgen-howto$ time gepolymaskgen --feather -100 --feather_border 1 --base_image glandsat_15m_bhutan_missing_imagery.khvr --invert --feather 50 --and_neg_mask bhutan.kml --output_mask glandsat_15m_bhutan_missing_imagery-mask.tif</code></p>
<p><code>Fusion Notice: Feather -100</code></p>
<p><code>Fusion Notice: Feather border 1</code></p>
<p><code>Fusion Notice: Base image: glandsat_15m_bhutan_missing_imagery.khvr</code></p>
<p><code>Fusion Notice: glandsat_15m_bhutan_missing_imagery.khvr width: 30720 height: 30720</code></p>
<p><code>Fusion Notice: north: 2.882812e+01 south: 2.619141e+01 east: 9.114258e+01 west: 8.850586e+01</code></p>
<p><code>Fusion Notice: File type: KHM/Keyhole Mosaic</code></p>
<p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
<p><code>Fusion Notice: Invert</code></p>
<p><code>Fusion Notice: Feather 50</code></p>
<p><code>Fusion Notice: AND mask: bhutan.kml</code></p>
<p><code>Fusion Notice: Output mask: glandsat_15m_bhutan_missing_imagery-mask.tif</code></p>
<p><code>Fusion Notice: Setting feather -100.</code></p>
<p><code>Fusion Notice: Feather border is on.</code></p>
<p><code>Fusion Notice: Setting base image glandsat_15m_bhutan_missing_imagery.khvr.</code></p>
<p><code>Total tiles to process: 1</code></p>
<p><code>Completed 100% (1/1) - tiles/sec: 0.04 - time left: 00:00:00 [CPU: 99 Mem: 1990 MB PF: 0]</code></p>
<p><code>Processed 1 tiles</code></p>
<p><code>Total time to process: 00:00:23</code></p>
<p><code>Average tiles per second: 0.04</code></p>
<p><code>Fusion Notice: Inverting current mask.</code></p>
<p><code>Fusion Notice: Setting feather 50.</code></p>
<p><code>Fusion Notice: Writing alpha file glandsat_15m_bhutan_missing_imagery-mask.tif</code></p>
<p><code>Fusion Notice: Executing: ogr2ogr -t_srs 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]' /tmp/p14999QFR8Mx/tmp.shp bhutan.kml</code></p>
<p><code>Warning 6: Normalized/laundered field name: 'Description' to 'Descriptio'</code></p>
<p><code>Fusion Notice: Executing: gdal_rasterize -b 1 -burn 255 -l tmp /tmp/p14999QFR8Mx/tmp.shp glandsat_15m_bhutan_missing_imagery-mask.tif</code></p>
<p><code>0...10...20...30...40...50...60...70...80...90...100 - done.</code></p>
<p><code>Total tiles to process: 1</code></p>
<p><code>Completed 100% (1/1) - tiles/sec: 0.04 - time left: 00:00:00 [CPU: 93 Mem: 3262 MB PF: 0]</code></p>
<p><code>Processed 1 tiles</code></p>
<p><code>Total time to process: 00:00:23</code></p>
<p><code>Average tiles per second: 0.04</code></p>
<p><code>Fusion Notice: AND-ing mask with new mask.</code></p>
<p><code>Fusion Notice: Saving mask to glandsat_15m_bhutan_missing_imagery-mask.tif.</code></p>
<p><code>Fusion Notice: Writing alpha file glandsat_15m_bhutan_missing_imagery-mask.tif</code></p>
<p><code>real 1m24.041s</code></p>
<p><code>user 1m11.650s</code></p>
<p><code>sys 0m11.990s</code></p>
<p>The resulting mask file will be approximately 900 MB in file size. Screenshots of the finished mask and the resulting image resource are included below.</p>
<h4>Custom mask which masks missing interior imagery with feathered edge as viewed in the GIMP photo editing tool:</h4>
<p><img alt="Custom mask with missing imagery in GIMP" src="../art/custom_masks/image08.jpg"/></p>
<h4>Resulting image resource built by Fusion after the custom mask is imported. Lower resolution imagery from the resource under the 15-meter imagery will be visible from the internal area masked from view: </h4>
<p><img alt="Image in Fusion after custom mask import" src="../art/custom_masks/image22.jpg"/></p>
<p>The custom mask file may now be imported into Fusion Pro with the source imagery by enabling the <code>havemask</code> masking mode in the Fusion Pro Resource Editor or by specifying the <code>gemodifyimageryresource --havemask</code> option on the command line. </p>
<p>Please see <a href="#h.wwsxau-f5geku">Appendix A</a> for further information about enabling the <code>havemask</code> mask mode for an image resource.</p>
<div class="note"> <strong>Note: </strong> This mask file could also be created in two steps as well - the first step to create the base mask file (<strong>picture frame</strong>) that provides a feathered edge for the overall image, and the second step to apply the internal mask with the specified <code>KML</code> file. Multiple areas may be removed from the internal portion of the image mask as separate operations. </div>
<h4><a id="h.ybl84i-pp3qv8" name="h.ybl84i-pp3qv8"></a>Example B: Creating an edge-matched mask with a feathered edge and masking missing internal imagery in two steps</h4>
<p>This example will create the custom mask in two command sequences: in the first step the a feathered edge mask based on the source image (<code>--base_image</code>) is built; and in the second step, a <code>KML</code> file to mask out the area of missing imagery is applied to the mask built in the first step.</p>
<p>The <strong>command template</strong> to create the mask are: </p>
<ol class="spaced-list">
  <li><strong>Create the edge mask (picture frame):</strong>
    <p> <code>gepolymaskgen --feather -100 --feather_border 1 --base_image source_imagery.khvr --invert --output_mask source_imagery-basemask.tif</code></p>
  </li>
  <li><strong>Mask the area of missing imagery from the mask built in the previous step:</strong>
    <p> <code>gepolymaskgen --base_mask source_imagery-basemask.tif --feather 50 --and_neg_mask missing-imagery-area.kml --output_mask source_imagery-mask.tif</code></p>
  </li>
</ol>
<p>Console output for creating the mask file in one step is as follows:</p>
<ol class="spaced-list">
  <li><strong>Create the edge mask (picture frame):</strong>
    <p><code>jcain@machine123:/gevol-local/src/gepolymaskgen-howto$ time gepolymaskgen --feather -100 --feather_border 1 --base_image glandsat_15m_bhutan_missing_imagery.khvr --invert --output_mask glandsat_15m_bhutan_missing_imagery-basemask.tif</code></p>
    <p><code>Fusion Notice: Feather -100</code></p>
    <p><code>Fusion Notice: Feather border 1</code></p>
    <p><code>Fusion Notice: Base image: glandsat_15m_bhutan_missing_imagery.khvr</code></p>
    <p><code>Fusion Notice: glandsat_15m_bhutan_missing_imagery.khvr width: 30720 height: 30720</code></p>
    <p><code>Fusion Notice: north: 2.882812e+01 south: 2.619141e+01 east: 9.114258e+01 west: 8.850586e+01</code></p>
    <p><code>Fusion Notice: File type: KHM/Keyhole Mosaic</code></p>
    <p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
    <p><code>Fusion Notice: Invert</code></p>
    <p><code>Fusion Notice: Output mask: glandsat_15m_bhutan_missing_imagery-basemask.tif</code></p>
    <p><code>Fusion Notice: Setting feather -100.</code></p>
    <p><code>Fusion Notice: Feather border is on.</code></p>
    <p><code>Fusion Notice: Setting base image glandsat_15m_bhutan_missing_imagery.khvr.</code></p>
    <p><code>Total tiles to process: 1</code></p>
    <p><code>Completed 100% (1/1) - tiles/sec: 0.04 - time left: 00:00:00 [CPU: 97 Mem: 1990 MB PF: 0]</code></p>
    <p><code>Processed 1 tiles</code></p>
    <p><code>Total time to process: 00:00:23</code></p>
    <p><code>Average tiles per second: 0.04</code></p>
    <p><code>Fusion Notice: Inverting current mask.</code></p>
    <p><code>Fusion Notice: Saving mask to glandsat_15m_bhutan_missing_imagery-basemask.tif.</code></p>
    <p><code>Fusion Notice: Writing alpha file glandsat_15m_bhutan_missing_imagery-basemask.tif</code></p>
    <p><code>real 0m36.297s</code></p>
    <p><code>user 0m32.370s</code></p>
    <p><code>sys 0m3.620s</code></p>
    <p>The resulting mask will be approximately 900MB in filesize.</p>
    <h4>Edge mask created with gepolymaskgen as viewed in the GIMP photo editing tool:</h4>
    <p><img alt="gepolymaskgen Edge mask in GIMP " src="../art/custom_masks/image06.jpg"/></p>
  </li>
  <li><strong>Mask the area of missing imagery from the mask built in the previous step:</strong>
    <p><code>jcain@machine123:/gevol-local/src/gepolymaskgen-howto$ time gepolymaskgen --base_mask glandsat_15m_bhutan_missing_imagery-basemask.tif --feather 50 --and_neg_mask bhutan.kml --output_mask glandsat_15m_bhutan_missing_imagery-mask.tif</code></p>
    <p><code>Fusion Notice: Base mask: glandsat_15m_bhutan_missing_imagery-basemask.tif</code></p>
    <p><code>Fusion Notice: glandsat_15m_bhutan_missing_imagery-basemask.tif width: 30720 height: 30720</code></p>
    <p><code>Fusion Notice: north: 2.882812e+01 south: 2.619141e+01 east: 9.114258e+01 west: 8.850586e+01</code></p>
    <p><code>Fusion Notice: File type: GTiff/GeoTIFF</code></p>
    <p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
    <p><code>Fusion Notice: Feather 50</code></p>
    <p><code>Fusion Notice: AND mask: bhutan.kml</code></p>
    <p><code>Fusion Notice: Output mask: glandsat_15m_bhutan_missing_imagery-mask.tif</code></p>
    <p><code>Fusion Notice: Setting base mask glandsat_15m_bhutan_missing_imagery-basemask.tif.</code></p>
    <p><code>Fusion Notice: Setting feather 50.</code></p>
    <p><code>Fusion Notice: Writing alpha file glandsat_15m_bhutan_missing_imagery-mask.tif</code></p>
    <p><code>Fusion Notice: Executing: ogr2ogr -t_srs 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]' /tmp/p15693nKOdrD/tmp.shp bhutan.kml</code></p>
    <p><code>Warning 6: Normalized/laundered field name: 'Description' to 'Descriptio'</code></p>
    <p><code>Fusion Notice: Executing: gdal_rasterize -b 1 -burn 255 -l tmp /tmp/p15693nKOdrD/tmp.shp glandsat_15m_bhutan_missing_imagery-mask.tif</code></p>
    <p><code>0...10...20...30...40...50...60...70...80...90...100 - done.</code></p>
    <p><code>Total tiles to process: 1</code></p>
    <p><code>Completed 100% (1/1) - tiles/sec: 0.04 - time left: 00:00:00 [CPU: 90 Mem: 3228 MB PF: 0]</code></p>
    <p><code>Processed 1 tiles</code></p>
    <p><code>Total time to process: 00:00:23</code></p>
    <p><code>Average tiles per second: 0.04</code></p>
    <p><code>Fusion Notice: AND-ing mask with new mask.</code></p>
    <p><code>Fusion Notice: Saving mask to glandsat_15m_bhutan_missing_imagery-mask.tif.</code></p>
    <p><code>Fusion Notice: Writing alpha file glandsat_15m_bhutan_missing_imagery-mask.tif</code></p>
    <p><code>real 0m56.214s</code></p>
    <p><code>user 0m44.330s</code></p>
    <p><code>sys 0m11.890s</code></p>
    <p>The resulting mask file will be approximately 900MB in filesize.</p>
    <h4>Merged mask built with gepolymaskgen with feathered edge and internal image masking for area of missing imagery as viewed in the GIMP photo editing tool:</h4>
    <p><img alt="gepolymaskgen merged mask in GIMP" src="../art/custom_masks/image08.jpg"/></p>
    <p>The custom mask file may now be imported into Fusion Pro with the source imagery by enabling the <code>havemask</code> masking mode in the Fusion Pro Resource Editor or by specifying the <code>gemodifyimageryresource --havemask</code> option on the command line. </p>
    <p>Please see <a href="#h.wwsxau-f5geku">Appendix A</a> for further information about enabling the <code>havemask</code> mask mode for an image resource.</p>
  </li>
</ol>
<hr/>
<h3><a id="h.6wiupq-gddwoq" name="h.6wiupq-gddwoq"></a>Case 5: Building custom masks with both gemaskgen and gepolymaskgen</h3>
<p>There are special cases where the capabilities of both <code>gemaskgen</code> and <code>gepolymaskgen</code> are needed to build a custom mask file for an image resource. The SFBayAreaLansat imagery from the Google Earth Enterprise Fusion Pro Tutorial is a good example (screenshot below).</p>
<h4>Screenshot of the usgsLanSat.tif source file imported into Fusion Pro viewed with no mask. Note the areas of fill data surrounding the imagery: </h4>
<p><img alt="usgsLanSat.tif in Fusion pro with no mask" src="../art/custom_masks/image19.jpg"/></p>
<h4>Screenshot of the usgsLanSat.tif imagery after being imported into Fusion Pro with a mask automatically computed:</h4>
<p><img alt="usgsLanSat.tif in Fusion pro with a mask" src="../art/custom_masks/image15.jpg"/></p>
<h4>Screenshot of the imported SFBayAreaLanSat image resource in Fusion after the custom mask is created:</h4>
<p><img alt="SFBayAreaLanSat image in fusion with custom mask" src="../art/custom_masks/image12.jpg"/></p>
<p>Here, the Fusion Pro automask function is needed to build a mask for the source imagery to mask all Fill Data; however, the imagery also includes imagery for the water which should be, ideally, masked to the coastline. Both <code>gemaskgen</code> and <code>gepolymaskgen</code> will be needed to accomplish this type of masking situation to build a mask hiding fill data within the image and then creating a coastline mask. This example is a special case since the source imagery must be imported into Fusion format first, then the custom mask will be generated from the output of the imagery resource build process. This example will also utilize information found in Appendixes <a href="#h.h6hjk6-u3u8xg">B</a>, <a href="#h.o23346-tgkrx4">C</a> and <a href="#h.p9e53m-jf2wqc">D</a> for locating masks built with <code>gemaskgen</code>. </p>
<p>The workflow to accomplish this custom mask will be:</p>
<ol>
  <li>Import the source imagery as a Fusion Pro image resource</li>
  <li>Use the mask file built during the image resource import as the base mask for <code>gepolymaskgen</code></li>
  <li>Mask the imagery to the coastline and write out the new mask</li>
  <li>Enable the <code>havemask</code> mask mode for the Image resource to import the custom mask</li>
</ol>
<p>The <strong>command templates</strong> for building this custom mask will be:</p>
<ol class="spaced-list">
  <li><strong>Locate the mask computed during the image resource build:</strong>
    <p><code>gequery --outfiles Resources/Imagery/YourImageResource.kiasset/maskgen.kia</code><br/>
      <code>/gevol/assets/Resources/Imagery/YourImageResource.kiasset/maskgen.kia/ver001/mask.tif</code></p>
  </li>
  <li><strong>Create an inverted version of the mask:</strong>
    <p><code>/gevol/assets/Resources/Imagery/YourImageResource.kiasset/maskgen.kia/ver001/mask.tif --invert --output_mask /gevol/src/path/to/source/imagery-basemaskinverted.tif</code></p>
  </li>
  <li><strong>Create a coastline mask using the mask as a base image:</strong>
    <p><code>gepolymaskgen --base_image </code></p>
    <p><code>/gevol/src/path/to/source/imagery-basemaskinverted.tif --invert --feather 100 --and_neg_mask /gevol/src/coastlines.shp --output_mask /gevol/src/path/to/source/imagery-coastlinesinverted.tif</code></p>
  </li>
  <li><strong>Merge the two mask files to the final custom mask:</strong>
    <p><code>gepolymaskgen --base_mask /gevol/src/path/to/source/imagery-basemaskinverted.tif --invert --and_neg_mask /gevol/src/path/to/source/imagery-coastlinesinverted.tif --output_mask /gevol/src/path/to/source/imagery-mask.tif</code></p>
    <p>The resulting <code>imagery-mask.tif</code> custom mask may then be imported with the source imagery and applied to the image resource in Google Earth Enterprise Fusion Pro.</p>
  </li>
</ol>
<p>An example workflow is included below which constructs a custom mask - masking both fill data automatically with <code>gemaskgen</code> and the coastlines with <code>gepolymaskgen</code> - for the SFBayAreaLanSat imagery resource built during the Google Earth Enterprise Fusion Tutorial. </p>
<ol class="spaced-list">
  <li><strong>Locate the computed mask file built when SFBayAreaLanSat built by gemaskgen</strong>
    <p><code>jcain@machine123:/gevol-local/gepolymaskgen$ gequery --infiles Resources/Imagery/SFBayAreaLanSat.kiasset/maskproduct.kia</code></p>
    <p><code>/gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/product.kia/ver001/raster.kip</code></p>
    <p><code>/gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/maskgen.kia/ver002/mask.tif</code></p>
  </li>
</ol>
<li><strong>Create a custom mask with gepolymaskgen using the gemaskgen base mask and mask to the coastlines (three steps)</strong>
  <p>a. Invert the mask file built during the Fusion Pro import:</p>
  <p><code>jcain@machine123:/gevol-local/gepolymaskgen$ sudo </code><strong><code>/opt/google/bin/gepolymaskgen --base_mask /gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/maskgen.kia/ver002/mask.tif --invert --output_mask /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertbasemask.tif</code></strong></p>
  <p><code>Fusion Notice: Base mask: /gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/maskgen.kia/ver002/mask.tif</code></p>
  <p><code>Fusion Notice: /gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/maskgen.kia/ver002/mask.tif width: 8206 height: 5856</code></p>
  <p><code>Fusion Notice: north: 3.846468e+01 south: 3.645418e+01 east: -1.207133e+02 west: -1.235306e+02</code></p>
  <p><code>Fusion Notice: File type: GTiff/GeoTIFF</code></p>
  <p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
  <p><code>Fusion Notice: Invert</code></p>
  <p><code>Fusion Notice: Output mask: /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertbasemask.tif</code></p>
  <p><code>Fusion Notice: Setting base mask /gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/maskgen.kia/ver002/mask.tif.</code></p>
  <p><code>Fusion Notice: Inverting current mask.</code></p>
  <p><code>Fusion Notice: Saving mask to /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertbasemask.tif.</code></p>
  <p><code>Fusion Notice: Writing alpha file /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertbasemask.tif</code></p>
  <p>b. Create a second mask file with the coastlines, inverted:</p>
  <p><code>jcain@machine123:/gevol-local/gepolymaskgen$ sudo </code><strong><code>/opt/google/bin/gepolymaskgen --base_image /gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/maskgen.kia/ver002/mask.tif --invert --feather 50 --and_neg_mask /gevol-local/src/gepolymaskgen-howto/world_coastlines_4326.shp --output_mask /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertcoastmask.tif </code></strong></p>
  <p><code>Fusion Notice: Base image: /gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/maskgen.kia/ver002/mask.tif</code></p>
  <p><code>Fusion Notice: /gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/maskgen.kia/ver002/mask.tif width: 8206 height: 5856</code></p>
  <p><code>Fusion Notice: north: 3.846468e+01 south: 3.645418e+01 east: -1.207133e+02 west: -1.235306e+02</code></p>
  <p><code>Fusion Notice: File type: GTiff/GeoTIFF</code></p>
  <p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
  <p><code>Fusion Notice: Invert</code></p>
  <p><code>Fusion Notice: Feather -50</code></p>
  <p><code>Fusion Notice: AND mask: /gevol-local/src/gepolymaskgen-howto/world_coastlines_4326.shp</code></p>
  <p><code>Fusion Notice: Output mask: /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertcoastmask.tif</code></p>
  <p><code>Fusion Notice: Setting base image /gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/maskgen.kia/ver002/mask.tif.</code></p>
  <p><code>Fusion Notice: Inverting current mask.</code></p>
  <p><code>Fusion Notice: Setting feather -50.</code></p>
  <p><code>Fusion Notice: Writing alpha file /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertcoastmask.tif</code></p>
  <p><code>Fusion Notice: Executing: gdal_rasterize -b 1 -burn 255 -l world_coastlines_4326 /gevol-local/src/gepolymaskgen-howto/world_coastlines_4326.shp /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertcoastmask.tif</code></p>
  <p><code>0...10...20...30...40...50...60...70...80...90...100 - done.</code></p>
  <p><code>Total tiles to process: 1</code></p>
  <p><code>Completed 100% (1/1) - tiles/sec: 0.83 - time left: 00:00:00 [CPU: 7 Mem: 292 MB PF: 0]</code></p>
  <p><code>Processed 1 tiles</code></p>
  <p><code>Total time to process: 00:00:01</code></p>
  <p><code>Average tiles per second: 0.83</code></p>
  <p><code>Fusion Notice: AND-ing mask with new mask.</code></p>
  <p><code>Fusion Notice: Saving mask to /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertcoastmask.tif.</code></p>
  <p><code>Fusion Notice: Writing alpha file /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertcoastmask.tif</code></p>
  <p>c. Construct the final mask by merging the two mask files:</p>
  <p><code>jcain@machine123:/gevol-local/gepolymaskgen$ sudo </code><strong><code>/opt/google/bin/gepolymaskgen --base_mask /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertbasemask.tif --invert --and_neg_mask /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertcoastmask.tif --output_mask /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-mask.tif</code></strong></p>
  <p><code>Fusion Notice: Base mask: /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertbasemask.tif</code></p>
  <p><code>Fusion Notice: /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertbasemask.tif width: 8206 height: 5856</code></p>
  <p><code>Fusion Notice: north: 3.846468e+01 south: 3.645418e+01 east: -1.207133e+02 west: -1.235306e+02</code></p>
  <p><code>Fusion Notice: File type: GTiff/GeoTIFF</code></p>
  <p><code>Fusion Notice: Projection : 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433],AUTHORITY["EPSG","4326"]]'</code></p>
  <p><code>Fusion Notice: Invert</code></p>
  <p><code>Fusion Notice: AND mask: /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertcoastmask.tif</code></p>
  <p><code>Fusion Notice: Output mask: /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-mask.tif</code></p>
  <p><code>Fusion Notice: Setting base mask /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-invertbasemask.tif.</code></p>
  <p><code>Fusion Notice: Inverting current mask.</code></p>
  <p><code>Fusion Notice: Writing alpha file /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-mask.tif</code></p>
  <p><code>Fusion Notice: AND-ing mask with new mask.</code></p>
  <p><code>Fusion Notice: Saving mask to /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-mask.tif.</code></p>
  <p><code>Fusion Notice: Writing alpha file /opt/google/share/tutorials/fusion/Imagery/usgsLanSat-mask.tif</code></p>
</li>
<p>Screenshots of the mask files during the build process are included below for reference. Each mask file is approximately 50MB in file size.</p>
<h4>Mask computed by gemaskgen during SFBayAreaLanSat image resource import:</h4>
<p><img alt="mask by gemaskgen during SFBayAreaLanSat import" src="../art/custom_masks/image18.jpg"/></p>
<h4>Step A: Inverted base mask:</h4>
<p><img alt="Inverted base mask" src="../art/custom_masks/image25.jpg"/></p>
<h4>Step B: Inverted coastlines mask:</h4>
<p><img alt="Inverted coastlines mask" src="../art/custom_masks/image20.jpg"/></p>
<h4>Step C: Merged, finished custom mask: </h4>
<p><img alt="merged custom mask" src="../art/custom_masks/image01.jpg"/></p>
<p>The custom mask may now be imported into Google Earth Enterprise Fusion Pro with the image resource by enabling the <code>havemask</code> mask mode. </p>
<p>Please see <a href="#h.wwsxau-f5geku">Appendix A</a> for further details about importing the new custom mask with an image resource. </p>
<h4>A screenshot of the SFBayAreaLanSat image resource with the custom mask is viewable below:</h4>
<p><img alt="SFBayAreaLanSat image with custom mask" src="../art/custom_masks/image12.jpg"/></p>
<p>This example workflow utilized the mask file automatically computed by Fusion Pro during the image resource import. By default, the mask files created by <code>gemaskgen</code> will typically be low resolution with a maximum of 16,000 pixels on any one side. It is possible to create a higher resolution mask file by manually operating the gemaskgen command on the command line. </p>
<p>Please see <a href="#h.p9e53m-jf2wqc"> Appendix D</a> for further details.</p>
<hr/>
<h2><a id="h.wwsxau-f5geku" name="h.wwsxau-f5geku"></a>Appendix A: Importing custom masks with imagery and terrain resources in Google Earth Enterprise Fusion Pro</h2>
<p>Custom imagery mask files built by either <code>gemaskgen</code>, <code>gepolymaskgen</code>, or another third-party application will only be imported automatically if the <code>havemask</code> mask option is selected for an image or terrain resource. Custom masks may be created before an image is imported into Fusion Pro or built after the image has already been imported as a resource. For either case, the <code>havemask</code> masking mode may be enabled by either from the Fusion GUI Resource Editor or from the command line with the <code>--havemask </code>option. </p>
<p>Example procedures for enabling the <code>havemask</code> option by command line and the Fusion GUI are available below as reference. Further details about the Fusion GUI Resource Editor and the command line tools <code>genewimageryresource</code> and <code>gemodifyimageryresource</code> may be found in the "Google Earth Enterprise Fusion Reference Guide" <strong>Defining Resources</strong> section and the <strong>Command Line Reference</strong> section. </p>
<p>Four examples cases are included below as a reference - two for enabling <code>havemask</code> mode within the Fusion GUI for new or existing image resources, and two for enabling <code>havemask</code> mode on the command line.</p>
<hr/>
<h3><a id="h.482jhk-rn8tuq" name="h.482jhk-rn8tuq"></a>Example 1: Enable havemask mode in the Fusion GUI for a new image resource</h3>
<ol class="spaced-list">
  <li>Move the custom mask file to the same folder as the source file for the image.</li>
  <li>Rename the custom mask file to be the same filename as the source image file with a <code>-mask.tif</code> extension.<br/>
    <p> For example: If the <code>/gevol/src/imagery/example.tif</code> is the source file, then the custom mask must be </p>
    <p><code>/gevol/src/imagery/example-mask.tif</code></p>
  </li>
  <li>Load the Fusion GUI Asset Manager:
    <p><img alt="Fusion GUI Asset Manager" src="../art/custom_masks/image14.jpg"/></p>
  </li>
  <li>Start a new image resource and specify the source file, provider, acquisition date</li>
  <li>Set the Mask Type to Have Mask from the Mask Options drop-down menu
    <p><img alt="Mask Options drop down menu" src="../art/custom_masks/image17.jpg"/></p>
  </li>
  <li>Save the image resource, specifying the location and name for the new image resource.</li>
  <li>Build the image resource.</li>
  <li>Once complete, load the newly built Fusion image resource into the Preview window to view the results. Proceed building the image resource into an imagery project if the custom mask is satisfactory, or continue working on the custom mask and repeat the import process until satisfied with the custom mask. </li>
</ol>
<hr/>
<h3><a id="h.4ca70y-vkbi43" name="h.4ca70y-vkbi43"></a>Example 2: Enable havemask mode by command line for a new image resource</h3>
<ol class="spaced-list">
  <li>Move the custom mask file to the same folder as the source file for the image.</li>
  <li>Rename the custom mask file to be the same filename as the source image file with a <code>-mask.tif</code> extension.
    <p> For example if the:</p>
    <p> <code>/gevol/src/imagery/example.tif</code> is the source file, then the custom mask must be: </p>
    <p> <code>/gevol/src/imagery/example-mask.tif</code></p>
  </li>
  <li>On the command line, enter:
    <p><code>genewimageryresource --havemask --sourcedate '0000-00-00' --provider 'USGS' -o Resources/Imagery/Example-Imagery /gevol/src/imagery/example.tif</code> </p>
    <p>replacing the provider, sourcedate and resource name to suit the imagery being imported.</p>
  </li>
  <li>Build the image resource by entering:
    <p> <code>gebuild Resources/Imagery/Example-Imagery </code>on the command line</p>
  </li>
  <li>Once the image resource build is complete, load the newly built Fusion image resource into the Preview window to view the results. Proceed building the image resource into an imagery project if the custom mask is satisfactory, or continue working on the custom mask and repeat the import process until satisfied with the custom mask.</li>
</ol>
<hr/>
<h3><a id="h.mzywb6-etqfmz" name="h.mzywb6-etqfmz"></a>Example 3: Enable havemask mode in the Fusion GUI for an existing image resource</h3>
<ol class="spaced-list">
  <li>Move the custom mask file to the same folder as the source file for the image.</li>
  <li>Rename the custom mask file to be the same filename as the source image file with a <code>-mask.tif</code> extension.
    <p>For example if the: </p>
    <p> <code>/gevol/src/imagery/example.tif</code> is the source file, then the custom mask must be: </p>
    <p> <code>/gevol/src/imagery/example-mask.tif</code></p>
  </li>
  <li>Load the Fusion GUI Asset Manager:
    <p><img alt="Fusion GUI Asset Manager" src="../art/custom_masks/image14.jpg"/></p>
  </li>
  <li>Double-click on the name of the image resource for which the custom mask will be applied, or right-click on the image resource and select <strong>Modify </strong></li>
  <li>When the Resource Editor loads, change the Mask Type to Have Mask from the Mask Options drop-down menu
    <p><img alt="Mask Options drop down menu" src="../art/custom_masks/image17.jpg"/></p>
  </li>
  <li>Save the image resource.</li>
  <li>Build the image resource.</li>
  <li>Once the image resource build is complete, load the newly built Fusion image resource into the Preview window to view the results. Proceed building the image resource into an imagery project if the custom mask is satisfactory, or continue working on the custom mask and repeat the import process until satisfied with the custom mask.</li>
</ol>
<hr/>
<h3><a id="h.utxsvs-euyjjd" name="h.utxsvs-euyjjd"></a>Example 4: Enable havemask mode by command line for an existing image resource</h3>
<ol class="spaced-list">
  <li>Move the custom mask file to the same folder as the source file for the image.</li>
  <li>Rename the custom mask file to be the same filename as the source image file with a <code>-mask.tif</code> extension.
    <p>For example if the: </p>
    <p> <code>/gevol/src/imagery/example.tif</code> is the source file, then the custom mask must be: </p>
    <p> <code>/gevol/src/imagery/example-mask.tif</code></p>
  </li>
  <li>On the command line, enter:
    <p> <code>gemodifyimageryresource --havemask --sourcedate '0000-00-00' --provider 'USGS' -o Resources/Imagery/Example-Imagery /gevol/src/imagery/example.tif</code> </p>
    <p>replacing the provider, sourcedate and resource name to suit the imagery being imported. </p>
  </li>
  <li>Build the image resource by entering <code>gebuild Resources/Imagery/Example-Imagery </code>on the command line</li>
  <li>Once the image resource build is complete, load the newly built Fusion image resource into the Preview window to view the results. Proceed building the image resource into an imagery project if the custom mask is satisfactory, or continue working on the custom mask and repeat the import process until satisfied with the custom mask.</li>
</ol>
<hr/>
<h2><a id="#h.h6hjk6-u3u8xg" name="#h.h6hjk6-u3u8xg"></a>Appendix B: Locating mask files and Fusion format data in an Asset Root</h2>
<p>Several files are created by GEE Fusion Pro when building an imagery or terrain resource, including the Fusion-format version of the imagery (<code>.kip</code> extension) or terrain (<code>.ktp</code> extension), a computed mask file built by <code>gemaskgen</code>, and the Fusion-format version of the computed mask (<code>.kmp</code> extension). These files and folders may be located within the Asset Root with the help of the gequery command and the <code>--outfiles</code> and <code>--infiles</code> options. </p>
<p>These files may be desired for custom masking operations such as computing a new, higher resolution mask with <code>gemaskgen</code> - which is computed from a <code>.kip</code> or <code>.ktp</code> folder - or locating the mask automatically built with <code>gemaskgen</code> to add coastlines, such as described in the <a href="#h.6wiupq-gddwoq">Case 5 Example</a> section. This section of the How-To guide will provide command templates for locating the Fusion format versions of imagery and terrain within the GEE Fusion Asset Root, and locating a mask file built by <code>gemaskgen</code> during resource import. </p>
<hr/>
<h3><a id="h.1ccxia-clzb9" name="h.1ccxia-clzb9"></a>Example 1: Locate the Fusion format imagery (.kip) and mask (.kmp) files of an image resource</h3>
<p>The <code>gequery --outfiles</code> command can be used to locate the Fusion-format versions of imported imagery or terrain data, and the Fusion-format version of the mask file as these are the <strong>output</strong> of the Fusion resource. Here is an example command to find the Fusion format imagery (<code>.kip</code>) and mask (<code>.kmp</code>) files from the SFBayAreaLanSat image resource built during the Fusion Pro Tutorial:</p>
<p><code>jcain@machine123:/gevol-local/gepolymaskgen$ gequery --outfiles Resources/Imagery/SFBayAreaLanSat.kiasset</code></p>
<p><code>/gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/product.kia/ver001/raster.kip</code></p>
<p><code>/gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/maskproduct.kia/ver002/mask.kmp</code></p>
<p>The response from <code>gequery --outfiles</code> provides the full folder path where the <code>.kip</code> and <code>.kmp</code> folders are located that comprise the SFBayAreaLanSat image resource imagery and mask in Fusion format. The location of the <code>.kip</code> folder will be vital information to regenerate a mask with <code>gemaskgen</code> as noted in <a href="#h.o23346-tgkrx4">Appendix C</a>, or if working with an imagery dataset that is larger than 65,000 pixels on a side as noted in <a href="#h.p9e53m-jf2wqc"> Appendix D</a>. The version of the imagery <code>.kip</code> folder and mask <code>.kmp</code> folders will change over time as newer source imagery are imported for the image resource or changes are made to the automask. The <code>gequery --outfiles</code> command will report the full paths that relate to the most current version of the image resource. Further information about the gequery command may be found in the <code>gequery --help</code> menu. </p>
<hr/>
<h3><a id="h.4msdgq-91mbmf" name="h.4msdgq-91mbmf"></a>Example 2: Locate a mask.tif file automatically built by the automask feature of a Fusion resource build</h3>
<p>Finding the mask file automatically computed by <code>gemaskgen</code> during a resource import is slightly different since it is the output of a different phase of the image resource build, but is needed to build the <code>.kmp</code> folder. The <code>gequery --outfiles</code> options can help locate the mask file built by the Fusion automask tool <code>gemaskgen</code>. Here is an example command to locate the full path of the mask file computed by Fusion for the SFBayAreaLanSat image resource built during the Fusion Pro Tutorial:</p>
<p><code>jcain@machine123:/gevol-local/gepolymaskgen$ gequery --outfiles Resources/Imagery/SFBayAreaLanSat.kiasset/maskgen.kia</code></p>
<p><code>/gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/maskgen.kia/ver002/mask.tif</code></p>
<p>The response from <code>gequery --outfiles</code> provides the full path location to the mask file built by the <code>gemaskgen</code> tool when the automask masking mode is selected for a resource. This computed mask file is used to build the Fusion-format mask (<code>.kmp</code>) for a resource. It is possible to build complex mask files for image resources by combining output from the <code>gemaskgen</code> automask tool and the <code>gepolymaskgen</code> tool, as described in the <a href="#h.6wiupq-gddwoq">Case 5 Example</a> where the automatic fill data detection of <code>gemaskgen</code> can be combined with coastline masking capabilities of <code>gepolymaskgen</code>. </p>
<p>Please see the <a href="#h.6wiupq-gddwoq">Case 5 Example</a> for further details. </p>
<hr/>
<h3><a id="h.36qmui-enjrcd" name="h.36qmui-enjrcd"></a>Example 3: Locate the mask.tif file and Fusion format .kip file utilized for building the Fusion format .kmp (mask product)</h3>
<p>Two inputs are required by Fusion to convert a mask file from <code>GeoTIFF </code>format into Fusion format for use with an image or terrain resource: the location of the <code>mask.tif</code> file and the location of the correct <code>.kip</code> folder. Examples <a href="#h.1ccxia-clzb9">1</a> and <a href="#h.4msdgq-91mbmf">2</a> demonstrated how <code>gequery --outfiles</code> may be utilzed to determine the folder paths of the Fusion-format <code>.kip</code> and <code>.kmp</code> data and the location of the mask file computed by <code>gemaskgen</code> during the resource build.</p>
<p> The locations of the <code>.kip</code>and <code>mask.tif</code> files read in by Fusion for generating the Fusion-format <code>.kmp</code> mask may be found with the <code>gequery --infiles</code> option. This is useful in situations where a higher fidelity base mask file is needed for building a custom mask file, as described in the <a href="#h.6wiupq-gddwoq">Case 5 Example</a>. Here is the command to locate the full paths to the computed mask file (<code>gemaskgen</code>) and Fusion-format <code>.kip</code> folder for the SFBayAreaLanSat image resource built during the Fusion Pro Tutorial:</p>
<p><code>jcain@machine123:/gevol-local/gepolymaskgen$ gequery --infiles Resources/Imagery/SFBayAreaLanSat.kiasset/maskproduct.kia</code></p>
<p><code>/gevol-local/gepolymaskgen/Resources/Imagery/SFBayAreaLanSat.kiasset/product.kia/ver001/raster.kip</code></p>
<p><code>/opt/google/share/tutorials/fusion/Imagery/usgsLanSat-mask.tif</code></p>
<p>A new base mask file may be built with the <code>gemaskgen</code> command which permits a larger number of pixels to be used for developing the mask file - as described in <a href="#h.p9e53m-jf2wqc"> Appendix D</a> - which could then be used in conjunction with <a href="#h.6wiupq-gddwoq">Case 5 Example</a>, or as a base mask for very large image resources as described in <a href="#h.3wwhdu-olys6q">Appendix F</a>.</p>
<hr/>
<h2><a id="h.o23346-tgkrx4" name="h.o23346-tgkrx4"></a>Appendix C: Determining source file raster size with geinfo</h2>
<p>Google Earth Enterprise Fusion Pro includes a tool called <code>geinfo</code> capable of reporting metadata about source imagery and terrain files, including: </p>
<ul>
  <li>Overall raster dimensions, </li>
  <li>Pixel resolution, </li>
  <li>Geographic location of the data</li>
  <li>Native projection or geographic coordinate system</li>
  <li>Number of bands in the file</li>
  <li>Band format (ex: 8bit, 16bit)</li>
</ul>
<p><code>geinfo</code> is able to read the same raster source formats that can be imported as Fusion image resources, including <code>khvr</code> (virtual raster) files for the raster dimensions of a mosaic. </p>
<p>Mask files computed with the <code>gepolymaskgen</code> tool will be written out in <code>GeoTIFF</code> format and must be less than 2GB in total file size. The <code>geinfo</code> tool can be used to determine the overall raster size of the input source file by entering <code>geinfo source_imagery.tif</code> onto the command line, where GEE Fusion Pro is installed, and then mulitplying the source file raster width (pixels) and height (pixels) values. The product may be used to estimate the file size that would be created by <code>gepolymaskgen</code>, if the source file was specified as the <code>gepolymaskgen --base_image</code>. Example output from <code>geinfo</code> is included below for the California 15-meter Landsat imagery that was used with the <a href="#h.bx3u98-pvlwqy">Case 3 Example</a>. The raster dimensions for the mosaic are highlighted for quick reference. </p>
<p><code>jcain@machine123:/gevol-local/src/gepolymaskgen-howto$ geinfo glandsat_15m_california_bay_area.khvr</code></p>
<p><code>File Type:   KHM/Keyhole Mosaic</code></p>
<p><code style="background-color:yellow;">Raster Size: 35840,30720</code></p>
<p><code>Extents:     (ns) 38.496093750000,35.859375000000</code></p>
<p><code>             (ew) -121.113281250000,-124.189453125000</code></p>
<p><code>Pixel Size:  (xy) 0.000085830688,-0.000085830688</code></p>
<p><code>Keyhole Normalized {</code></p>
<p><code>     Raster Size: 35840,30720</code></p>
<p><code>     Extents:     (ns) 38.496093750000,35.859375000000</code></p>
<p><code>                  (ew) -121.113281250000,-124.189453125000</code></p>
<p><code>     Pixel Size:  (xy) 0.000085830688,-0.000085830688</code></p>
<p><code>     Top level:   22</code></p>
<p><code>}</code></p>
<p><code>Spatial Reference System:</code></p>
<p><code>GEOGCS["WGS 84",</code></p>
<p><code>    DATUM["WGS_1984",</code></p>
<p><code>        SPHEROID["WGS 84",6378137,298.257223563,</code></p>
<p><code>            AUTHORITY["EPSG","7030"]],</code></p>
<p><code>        AUTHORITY["EPSG","6326"]],</code></p>
<p><code>    PRIMEM["Greenwich",0],</code></p>
<p><code>    UNIT["degree",0.0174532925199433],</code></p>
<p><code>    AUTHORITY["EPSG","4326"]]</code></p>
<p><code>Corner Coordinates:</code></p>
<p><code>Upper Left  (-124.1894531,  38.4960938) (124d11'22.03"W, 38d29'45.94"N)</code></p>
<p><code>Lower Left  (-124.1894531,  35.8593750) (124d11'22.03"W, 35d51'33.75"N)</code></p>
<p><code>Upper Right (-121.1132812,  38.4960938) (121d 6'47.81"W, 38d29'45.94"N)</code></p>
<p><code>Lower Right (-121.1132812,  35.8593750) (121d 6'47.81"W, 35d51'33.75"N)</code></p>
<p><code>Center      (-122.6513672,  37.1777344) (122d39'4.92"W, 37d10'39.84"N)</code></p>
<p><code>Band 1 Block=2048x200 Type=Byte, ColorInterp=Red</code></p>
<p><code>  NoData Value=0</code></p>
<p><code>Band 2 Block=2048x200 Type=Byte, ColorInterp=Green</code></p>
<p><code>  NoData Value=0</code></p>
<p><code>Band 3 Block=2048x200 Type=Byte, ColorInterp=Blue</code></p>
<p><code>  NoData Value=0</code></p>
<p><code>Band 4 Block=2048x200 Type=Byte, ColorInterp=Alpha</code></p>
<p>Multiplying the raster dimensions together (<code>35840 x 30720</code>) results 1,101,004,800 which means a 1GB (approximate) mask file would be created if the <code>khvr</code> was specified as a <code>gepolymaskgen --base_image</code>. </p>
<hr/>
<h3><a id="h.drylio-qyapcq" name="h.drylio-qyapcq"></a>Maximum suggested raster dimensions for source files used as gepolymaskgen --base_image files</h3>
<p>Some suggested maximum raster dimensions are included as a rough guideline to help size and scope source files when creating custom masks. The source file should not be used as a base image for <code>gepolymaskgen</code> if the total raster size is larger than 2,000,000,000 pixels. For this case, a lower resolution image should be created as described in <a href="#h.p9e53m-jf2wqc">Appendix D</a>. </p>
<hr/>
<h3><a id="h.337igq-k0r1kk" name="h.337igq-k0r1kk"></a>Square-shaped rasters</h3>
<p>Perfectly square source raster files should be less than 44,000 pixels by 44,000 pixels for use as a base image, or base mask, with <code>gepolymaskgen</code>. A substitute base image or mask file should be created for square-shaped source images that are larger than 44,000 pixels on both sides, as described in <a href="#h.p9e53m-jf2wqc">Appendix D</a>.</p>
<hr/>
<h3><a id="h.vxiu8i-47rfer" name="h.vxiu8i-47rfer"></a>Rectangular-shaped rasters </h3>
<p>The maximum suggested raster dimensions for rectangular images varies by the amount of the longest side. Some suggested dimensions are included below for reference. </p>
<ul style="list-style: none;">
  <li>55,000 x 30,000</li>
  <li>60,000 x 35,000</li>
  <li>65,000 x 30,000</li>
  <li>70,000 x 27,000</li>
</ul>
<p>A substitute base image or mask file should be created if the source imagery is larger than these recommended dimensions, or if the product of the raster width and height is more than 2,000,000,000 pixels. Instructions for creating a substitute base image, with <code>gemaskgen</code>, may be found in <a href="#h.p9e53m-jf2wqc">Appendix D</a>.</p>
<hr/>
<h2><a id="h.p9e53m-jf2wqc" name="h.p9e53m-jf2wqc"></a>Appendix D: Building high resolution mask files with gemaskgen </h2>
<p>The <code>gemaskgen</code> automask utility has several options to automatically compute a mask file from an imported Fusion imagery resource (<code>.kip</code>); however, by default <code>gemaskgen</code> limits the computed mask to only be a maximum of 16,000 pixels on any one side which can result in low-resolution masks for high-resolution image resources. Higher resolution masks may be created by manually invoking the <code>gemaskgen</code> tool specifying a higher pixel value for the <code>--maxsize</code> option. </p>
<p><code>gemaskgen</code> requires access to the Fusion format version of the imagery resource to compute the mask file, which may be located either in the Fusion Asset Root or in a separate folder, depending if the imagery was processed by another system and copied to the Fusion system for use, or if a <code>KRP.taskrule</code> taskrule file redirects output from Fusion resource imports to another volume. The location of both the <code>.kip</code> folder Fusion-format imagery and <code>mask.tif</code> file may be found with the <code>gequery --infiles</code> command as described in <a href="#h.h6hjk6-u3u8xg">Appendix B</a>, <a href="#h.36qmui-enjrcd">Example 3</a>. </p>
<p>The exact settings used by <code>gemaskgen</code> when building a mask file for an image resource may be found from the <code>gemaskgen</code> log file, available in the Google Earth Enterprise Fusion Pro Asset Manager. To access the log file, load the Asset Manager and right-click on the desired image resource. Select the <strong>Current Version Properties</strong> entry then expand the <code>CHILD.KRMP</code> item until the <code>Maskgen.kia&amp;</code> entry is visible. </p>
<p><img alt="maskgen version properties" src="../art/custom_masks/image44.jpg"/></p>
<p>Left-click once on the logfile icon to the right of the <code>Maskgen.kia</code> entry to open the Logfile.</p>
<p><img alt="Maskgen Logfile diagram" src="../art/custom_masks/image26.jpg"/></p>
<p>The <code>gemaskgen</code> command executed by Fusion Pro during the image resource build is visible at the top of the log file on the line starting with <code>COMMAND</code>. This command may be utilized as a template for building a higher resolution mask by also including the <code>--maxsize</code> option. </p>
<p>An example <code>gemaskgen</code> use will be included below that will build a mask for the <code>example-imagery.kip</code> image resource with a maximum size of 55,000 pixels, feathered 100 pixels into the imagery, with fill data set to pixel value 0: </p>
<p><code>jcain@machine123:/gevol-local/src/gepolymaskgen-howto$ time gemaskgen --mask --maxsize 55000 --feather 100 /path/to/example-imagery.kip /path/to/example-imagery-mask.tif</code></p>
<p><code>gemaskgen </code>will read the <code>example-imagery.kip</code> folder and compute a mask file that masks Fill Data pixels and builds a feathered edge of 100 pixels into the usable imagery. The actual output dimensions of the computed mask varies from case to case; however, <code>gemaskgen</code> will restrict the maximum length of either the height or width to 55,000 pixels. Additional information about recommended mask dimensions may be found in <a href="#h.o23346-tgkrx4">Appendix C</a>. Once complete, the mask file computed by <code>gemaskgen</code> may be used as a base image for building a custom mask with <code>gepolymaskgen</code> and then imported with the image resource as described in <a href="#h.wwsxau-f5geku">Appendix A</a>. </p>
<p>Further information about available <code>gemaskgen</code> options may be from the <code>gemaskgen --help</code> menu. </p>
<hr/>
<h2><a id="h.nt1nwm-ygzycp" name="h.nt1nwm-ygzycp"></a>Appendix E: Using a Photo Editing application to augment a custom mask</h2>
<p>This is a special section for manually modifying a custom mask for an imagery resource. Both the <code>gepolymaskgen</code> and <code>gemaskgen</code> tools are able to build high quality masks to accompany image resources; however, there are cases where neither tool may be able to provide the correct solution for a set of imagery. Consider the mask and imagery resource from the <a href="#h.6wiupq-gddwoq">Case 5 Example</a> based on the SFBayAreaLanSat image resource for California (below) where <code>gemaskgen</code> successfully masked Fill Data from view and <code>gepolymaskgen</code> successfully masked ocean imagery to the specified coastline. The resulting mask masks out the San Francisco Bay which makes the low-resolution BlueMarble imagery visible (green).</p>
<h4>SFBayAreaLanSat image resource as completed in Example Case 5:</h4>
<p><img alt="SFBayAreaLanSat image with custom mask" src="../art/custom_masks/image12.jpg"/></p>
<h4>SFBayAreaLanSat image resource with automasking only:</h4>
<p><img alt="SFBayAreaLanSat image with automask" src="../art/custom_masks/image27.jpg"/></p>
<p>One solution for this case is to manually modify the finished custom mask with a photo editing tool such as GIMP or Adobe Photoshop to alter the mask to show more imagery, or less imagery based on the circumstance. In this example, the <code>usgsLanSat-mask.tif</code> custom mask will modified such that imagery for the San Francisco Bay will be visible in the final image resource while still masking imagery to the California Coastline. Here is the workflow for manually modifying the mask file for the SFBayAreaLanSat image resource: </p>
<ol class="spaced-list">
  <li>Load the usgsLanSat-mask.tif mask file created from the <a href="#h.6wiupq-gddwoq">Case 5 Example</a> into the photo editing application
    <p><img alt="merged custom mask" src="../art/custom_masks/image01.jpg"/></p>
  </li>
  <li>Select the paintbrush tool and set to paint with white fill(255). The pixel width, opacity, and feather value of the brush needed will vary for each mask.</li>
  <br/>
  <li>Brush out the entire San Francisco Bay to remove the bay coastline mask
    <p><img alt="bay coastline mark removed" src="../art/custom_masks/image04.jpg"/></p>
  </li>
  <li>Save the updated mask file to the same folder location as the <code>usgsLanSat.tif</code> source image file for the SFBayAreaLanSat image resource<code> - /opt/google/share/tutorials/fusion/Imagery</code></li>
  <br/>
  <li>Modify the SFBayAreaLanSat image resource to enable the <code>HaveMask</code> mask mode.
    <p>Please see <a href="#h.wwsxau-f5geku">Appendix A</a>, Examples <a href="#h.mzywb6-etqfmz">3</a> and <a href="#h.utxsvs-euyjjd">4</a> for further details.</p>
  </li>
  <li>Build the image resource to import the updated mask file.</li>
  <br/>
  <li>Load the SFBayAreaLanSat image resource into the Fusion Pro Preview <br/>
    <h4>usgsLanSat mask after mask updates to show the imagery for the San Francisco Bay:</h4>
    <img alt="san francisco bay with usgsLanSat mask" src="../art/custom_masks/image12.jpg"/> </li>
</ol>
<br/>
<h4>usgsLanSat mask before mask edits:</h4>
<p><img alt="usgsLanSat before mask" src="../art/custom_masks/image27.jpg"/></p>
<hr/>
<h2><a id="h.3wwhdu-olys6q" name="h.3wwhdu-olys6q"></a>Appendix F: Building custom masks for large source imagery</h2>
<p>This is a special section intended for use when working with source imagery datasets - such as an image resource of 0.5-meter per pixel resolution 3-band, color imagery for an entire state - where a high-fidelity mask is desired could easily create a mask file larger than 2GB in filesize. The same tools described in this document and appendices can be used to construct a custom mask that provides high fidelity masking for the image resource while being less than 2GB in file size. The key difference in the workflow for building custom mask for large imagery resources - where the image resource will have more than 65,000 pixels on one side - is the source imagery are imported first, then <code>gemaskgen</code> is called manually to create a stand-in base mask file for use with <code>gepolymaskgen</code>. This workflow is similar to the <a href="#h.6wiupq-gddwoq">Case 5 Example</a> where the image resource was imported first into Fusion Pro and then a custom mask was generated and added after import. </p>
<p>The general workflow for this use case will be:</p>
<p>Assuming the source imagery is detected to be larger than 65,000 pixels on one side (or more than 2,000,000,000 total pixels) with <code>geinfo</code> (See <a href="#h.o23346-tgkrx4">Appendix C</a>);</p>
<ol class="spaced-list">
  <li>Import the image resource with Fusion Pro;</li>
  <li>View the finished image resource in the Fusion Pro window to determine what type of masking may be needed so an appropriate example Case may be referenced;</li>
  <li>Find the full paths to the imported, Fusion-format <code>kip</code> folder for the imagery with the <code>gequery --outfiles command</code> (See <a href="#h.h6hjk6-u3u8xg">Appendix B</a>, <a href="#h.1ccxia-clzb9">Example 1</a>)</li>
  <li>Generated a 'stand-in' base mask file with <code>gemaskgen</code> that will construct an image less than 2,000,000,000 total pixels (See <a href="#h.p9e53m-jf2wqc"> Appendix D</a> for Creating the mask and <a href="#h.o23346-tgkrx4">Appendix C</a> for Recommended mask sizes)</li>
  <li>Construct a custom mask with <code>gepolymaskgen</code> referencing the <strong>stand-in</strong> image from <a href="#h.6wiupq-gddwoq">Case 5 Example</a> as the <code>--base_image</code>. Reference one of the five example cases for additional steps in constructing the custom mask.</li>
  <li>Update the image resource configuration to enable <code>havemask</code> mode so the custom mask will be imported and applied to the image resource (See <a href="#h.wwsxau-f5geku">Appendix A</a>, Examples <a href="#h.mzywb6-etqfmz">3</a> and <a href="#h.utxsvs-euyjjd">4</a>)</li>
  <li>Build the image resource to commit the change and import the new custom mask, then view the image resource in the Fusion Preview window.</li>
</ol>
<hr/>
<h2><a id="h.lafpls-5an7c8" name="h.lafpls-5an7c8"></a>Appendix G: gepolymaskgen help menu</h2>
<p>A full copy of the help contents for <code>gepolymaskgen</code> is available in this appendix for reference:</p>
<p><code>usage: gepolymaskgen --help | -?</code></p>
<p><code>       gepolymaskgen [--feather &lt;int_feather&gt;] --base_mask &lt;geotiff_mask_file&gt; [options] --output_mask &lt;geotiff_mask_file&gt;</code></p>
<p><code>       gepolymaskgen [--feather &lt;int_feather&gt;] --base_image &lt;geotiff_image_file&gt; [options] --output_mask &lt;geotiff_mask_file&gt;</code></p>
<p><code> Options are applied in order given.</code></p>
<p><code> Valid options:</code></p>
<p><code>       --feather &lt;int_feather&gt;:     Feather to apply to all </code></p>
<p><code>                                    subsequent masks until a</code></p>
<p><code>                                    different feather is given.</code></p>
<p><code>                                    Feather can be 0, positive,</code></p>
<p><code>                                    or negative. Default is 0.</code></p>
<p><code>       --feather_border &lt;int_flag&gt;: If flag is non-zero, border</code></p>
<p><code>                                    is feathered. Otherwise,</code></p>
<p><code>                                    border is left in tact.</code></p>
<p><code>                                    Flag remains in effect</code></p>
<p><code>                                    until it is modified.</code></p>
<p><code>                                    Default is border is</code></p>
<p><code>                                    feathered.</code></p>
<p><code>       --and_neg_mask &lt;mask_file&gt;:  Bitwise AND of negative image </code></p>
<p><code>                                    of polygon or raster mask</code></p>
<p><code>                                    with the current mask.</code></p>
<p><code>                                    Polygons can be given in</code></p>
<p><code>                                    .kml or .shp files and are</code></p>
<p><code>                                    assumed to be filled with</code></p>
<p><code>                                    0x00. Raster masks should be</code></p>
<p><code>                                    .tif files with the same pixel                                     </code></p>
<p><code>                                    dimensions as the base mask.</code></p>
<p><code>                                    Care should be taken not to                                    </code></p>
<p><code>                                    overlap feathered regions.</code></p>
<p><code>       --or_mask &lt;mask_file&gt;:       Bitwise OR polygon or raster</code></p>
<p><code>                                    mask to the current mask.</code></p>
<p><code>                                    Polygons can be given in</code></p>
<p><code>                                    .kml or .shp files and are</code></p>
<p><code>                                    assumed to be filled with</code></p>
<p><code>                                    0xff. Raster masks should be</code></p>
<p><code>                                    .tif files with the same pixel</code></p>
<p><code>                                    dimensions as the base mask.</code></p>
<p><code>                                    Care should be taken not to                                    </code></p>
<p><code>                                    overlap feathered regions.</code></p>
<p><code>       --threshold &lt;thresh_byte&gt;:   All pixels at or below the</code></p>
<p><code>                                    threshold byte are set to</code></p>
<p><code>                                    0x00; all other pixels are set</code></p>
<p><code>                                    to 0xff.</code></p>
<p><code>Please note that ordering of arguments is important; they are applied in the order that they are given. The feather argument implies that you are setting the feather to be used for any subsequent masks. E.g. to feather the base mask, you must set the feather before the base mask is given. Positive feathers erode the mask (white area retracts); negative feathers expand the mask (white area grows).</code></p>
<p><code> Examples:</code></p>
<p><code> -- simple polygon mask with no feathering</code></p>
<p><code>   gepolymaskgen --base_image /path/input_image.tif \</code></p>
<p><code>                 --or_mask /path/polygon.kml \</code></p>
<p><code>                 --output_mask /path/result_mask.tif</code></p>
<p><code> -- negative polygon mask with some feathering</code></p>
<p><code>   gepolymaskgen --base_image /path/input_image.tif \</code></p>
<p><code>                 --feather 30 \</code></p>
<p><code>                 --feather_border 0 \</code></p>
<p><code>                 --and_neg_mask /path/polygon.kml \</code></p>
<p><code>                 --invert \</code></p>
<p><code>                 --output_mask /path/result_mask.tif</code></p>
<p><code> -- OR and AND polygon and tiff masks with different feathers \</code></p>
<p><code>   gepolymaskgen --feather 30 \</code></p>
<p><code>                 --base_mask /path/base_mask.tif \</code></p>
<p><code>                 --feather 20 \</code></p>
<p><code>                 --feather_border 0 \</code></p>
<p><code>                 --or_mask /path/SF.kml \</code></p>
<p><code>                 --or_mask /path/daly_city.kml \</code></p>
<p><code>                 --feather 15 \</code></p>
<p><code>                 --feather_border 1 \</code></p>
<p><code>                 --or_mask /path/circle_mask.tif \</code></p>
<p><code>                 --feather 5 \</code></p>
<p><code>                 --and_neg_mask /path/gg_park.kml \</code></p>
<p><code>                 --and_neg_mask /path/northbeach.kml \</code></p>
<p><code>                 --feather 40 \</code></p>
<p><code>                 --and_neg_mask /path/circle_mask2.tif \</code></p>
<p><code>                 --output_mask /path/mask.tif</code></p>
<div class="footer"><p class="BackToTop"><a href="#top_of_file">Back to top</a> <hr /></p> <p class="copyright">&copy;2015 Google</p></div>
</div></body> </html>
