# Overview of the Build System Used in Open GEE

There are, at least, three separate software products in the Open GEE
repository:

* Server
* Fusion
* Portable Server

Each of them can have a few different items that can be built.  They include:

* Binary utilities and libraries
* Packages for installing on various operating systems
* Documentation for browsing off-line, or publishing on Open GEE Web sites

There are a few build tools used for building these items:

* SCons
* Gradle
* Python scripts

The code and build scripts for the different software products (Server,
Fusion, Portable Globe) are not modularized, and the build script for one
may reference the source code file structure for another.

## Building Binary Utilities and Libraries

### Server and Fusion Binaries

There's virtually no separation between the scripts for building Server and
Fusion.

This process is performed by running `scons build` in the `earth_enterprise`
directory.  It uses the SCons build tool, and has a few components of its own
than need to be built before compiling Open GEE source code:

* Bundled libraries
* Generated source code
* Fusion and Server library and executable binaries

The SCons scripts for these components use a class named `khEnvironment` that
derives from the SCons built-in `Environment`, and adds convenience methods.

Server and Fusion can be built with different options.  There is a build
directory name that's derived from the build options specified (e.g.,
`NATIVE-REL-x86_64` or `NATIVE-DBG-x86_64`), and is created in
`earth_enterprise/src` by default.

This build directory has some notable subdirectories:

* `bin` where built binaries are output
* `bin/tests` where built unit and other test binaries are output
* `lib` where built shared objects are output, and where shared objects
  are looked for during compilation
* `include` where include from built libraries are copied, and where header
  files are looked for during compilation

#### Bundled Libraries

Each bundled library has files in a few places:

* `earth_enterprise/third_party/<library-name>/<source-code-archive>.tar.gz`
* `earth_enterprise/third_party/<library-name>/LICENSE`
* `earth_enterprise/src/third_party/<library-name>/SConscript`

There may be other files along the source code archive, such as a README file,
patch files that are applied to the source code in the archive before
building, obsolete `.spec` files for building RPM packages for the library.

The `SConscript` file contains the build script that unpacks the library
source code archive, applies patches, builds the library, and copies built
binaries and other possible resources to the appropriated directories under
the current build directory.

All bundled libraries are built by
`earth_enterprise/src/third_party/SConscript` in an order in which each
library depends only on libraries listed before it in the build list.

#### Generated Source Code

Some source code is generated by scripts, such as `AssetGenDaemonH.pl` and
`AssetGenDaemonCpp.pl`.  The Perl commands are usually run from the same
`SConscript` that compiles the generated source code and links it into a
library, or an executable.

#### Library and Executable Binaries

Library and executable binaries for Fusion and Server are compiled and linked
by `SConscript`s in the various directories under `src`.

SCons has a mechanism for exporting variables from a parent `SConscript` to
one invoked by it, as well as for returning values from the invoked
`SConscript` to the parent.  The Fusion and Server `SConscript`s are organized
so that parent ones in a parent directory, and the ones invoked by them are in
subdirectories.  So, if there's an executable that depends on an object file,
the object file is built in the same `SConscript` as the executable, or is
built in a parent `SConscript` and its information is passed down through
exported variables.

### Portable Server Binaries

Portable Server is built by a standalone Python script,
`earth_enterprise/src/portableserver/build.py`.  The script accesses files with
build commands, and source code under the `src/fusion` directory.

## Building Operating System Packages

### Server and Fusion Packages

RPM and Deb packages can be built for Server and Fusion by the
`earth_enterprise/rpms/build.gradle` script.

### Portable Server Packages

Portable Server isn't packaged, yet.  Its build script produces a compressed
archive that contains the compiled binaries and Python scripts required for
running Portable Server on the platform that the build was executed on.
Currently, the build script can produce an archive for Linux and Windows, and
it has code for producing an archive for MacOS, but that last one hasn't been
tested.

## Building Documentation

There's GitHub pages documentation under `docs` that's built automatically by
GitHub's Jekyll tool.  It doesn't have any separate build script a user can
run.

There's also an `earth_enterprise/docs/SConscript` which copies HTML to a
directory that can be packaged with Open GEE.  However, operating system
packages with that documentation are not produced, yet.
