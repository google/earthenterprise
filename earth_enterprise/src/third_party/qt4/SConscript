#-*- Python -*-
#
# Copyright 2020 The OpenGEE Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

Import('third_party_env')
import os

qt_version = 'qt-everywhere-opensource-src-4.8.7'

make_cmd_cpu = 'make -j%d' % GetOption('num_jobs')

ge_version = qt_version.replace('qt', 'qt-ge')

current_dir = Dir('.').abspath
build_root = '%s/%s' % (current_dir, qt_version)
qt_source = File('#/../../earth_enterprise/third_party/qt4/%s.tar.gz'
                   % qt_version).abspath


qt_env = third_party_env.DeepCopy()

optdir = qt_env['optdir']
root_dir = Dir(qt_env.exportdirs['root']).abspath
qt_patches = ['qt-4.8-poll.patch',
              'qt-aarch64.patch',
              'qt-cupsEnumDests.patch',
              'qt-everywhere-opensource-src-4.6.2-cups.patch',
              'qt-everywhere-opensource-src-4.6.3-glib_eventloop_nullcheck.patch',
              'qt-everywhere-opensource-src-4.8.0-QTBUG-22037.patch',
              'qt-everywhere-opensource-src-4.8.0-s390-atomic.patch',
              'qt-everywhere-opensource-src-4.8.0-tp-multilib-optflags.patch',
              'qt-everywhere-opensource-src-4.8.0-tp-qtreeview-kpackagekit-crash.patch',
              'qt-everywhere-opensource-src-4.8.1-linguist_qmake-qt4.patch',
              'qt-everywhere-opensource-src-4.8.1-qt3support_debuginfo.patch',
              'qt-everywhere-opensource-src-4.8.2--assistant-crash.patch',
              'qt-everywhere-opensource-src-4.8.3-icu_no_debug.patch',
              'qt-everywhere-opensource-src-4.8.3-no_Werror.patch',
              'qt-everywhere-opensource-src-4.8.3-qdbusconnection_no_debug.patch',
              'qt-everywhere-opensource-src-4.8.4-qmake_pkgconfig_requires_private.patch',
              'qt-everywhere-opensource-src-4.8.5-mysql_config.patch',
              'qt-everywhere-opensource-src-4.8.5-qgtkstyle_disable_gtk_theme_check.patch',
              'qt-everywhere-opensource-src-4.8.5-QTBUG-14467.patch',
              'qt-everywhere-opensource-src-4.8.5-QTBUG-21900.patch',
              'qt-everywhere-opensource-src-4.8.5-QTBUG-35459.patch',
              'qt-everywhere-opensource-src-4.8.5-QTBUG-4862.patch',
              'qt-everywhere-opensource-src-4.8.5-qt_plugin_path.patch',
              'qt-everywhere-opensource-src-4.8.5-tds_no_strict_aliasing.patch',
              'qt-everywhere-opensource-src-4.8.5-uic_multilib.patch',
              'qt-everywhere-opensource-src-4.8.5-webcore_debuginfo.patch',
              'qt-everywhere-opensource-src-4.8.6-QTBUG-22829.patch',
              'qt-everywhere-opensource-src-4.8.6-QTBUG-37380.patch',
              'qt-everywhere-opensource-src-4.8.6-s390.patch',
              'qt-everywhere-opensource-src-4.8.6-system-clucene.patch',
              'qt-everywhere-opensource-src-4.8.6-systemtrayicon.patch',
              'qt-everywhere-opensource-src-4.8.7-alsa-1.1.patch',
              'qt-everywhere-opensource-src-4.8.7-crash-in-qppmhandler.patch',
              'qt-everywhere-opensource-src-4.8.7-firebird.patch',
              'qt-everywhere-opensource-src-4.8.7-gcc6.patch',
              'qt-everywhere-opensource-src-4.8.7-gcc8_qtscript.patch',
              'qt-everywhere-opensource-src-4.8.7-icu59.patch',
              'qt-everywhere-opensource-src-4.8.7-mariadb.patch',
              'qt-everywhere-opensource-src-4.8.7-mips64.patch',
              'qt-everywhere-opensource-src-4.8.7-openssl-1.1.patch',
              'qt-everywhere-opensource-src-4.8.7-qforeach.patch',
              'qt-everywhere-opensource-src-4.8.7-qmake_LFLAGS.patch',
              'qt-everywhere-opensource-src-4.8.7-QT_VERSION_CHECK.patch',
              'qt-x11-opensource-src-4.5.0-fix-qatomic-inline-asm.patch',
              'qt-x11-opensource-src-4.5.1-enable_ft_lcdfilter.patch']

qt_patches_p0 = ['qt-everywhere-opensource-src-4.8.6-QTBUG-34614.patch',
                 'qt-everywhere-opensource-src-4.8.6-QTBUG-38585.patch',
                 'qt-prefer_adwaita_on_gnome.patch']

if GetOption('clean'):
  qt_env.Execute('rm -rf %s' % current_dir)

# [1] Extract qt
qt_target = '%s/.extract' % current_dir
qt_extract = qt_env.Command(
    qt_target, [qt_source],
    [qt_env.MultiCommand(
        'mkdir -p %s\n'
        'cd %s\n'
        'tar xzf %s\n'
        'touch %s'% (current_dir, current_dir, qt_source, qt_target))])


# [2] Patch qt
qt_target = '%s/.patch_qt' % current_dir
qt_patch = qt_env.Command(
    qt_target,
    qt_extract + map(qt_env.GetBuildPath, qt_patches),
    [qt_env.MultiCommand(
        'cd %s\n'
        '%s\n'
        'touch %s' % (build_root,
                      '\n'.join(map(lambda i: 'patch -g0 -p1 -s < %s' % (
                          qt_env.GetBuildPath(i)), qt_patches) + 
                          map(lambda i: 'patch -g0 -p0 -s < %s' % (
                          qt_env.GetBuildPath(i)), qt_patches_p0)),
                      qt_target))])


# [7] Configure qt
qt_target = '%s/.configure_qt' % current_dir

configure_cmd = (
'cd %s\n'
'%s./configure -v -confirm-license -opensource -optimized-qmake -no-fast '
'--prefix=%s -release -shared -no-cups -fontconfig -largefile -gtkstyle '
'-no-phonon -no-phonon-backend -no-pch -no-javascript-jit -sm -stl -system-libmng -system-libpng '
'-system-libjpeg -system-libtiff -system-zlib -xinput -xcursor -xfixes -xinerama '
'-xshape -xrandr -xrender -xkb -glib -icu -no-openssl -xmlpatterns -no-dbus '
'-graphicssystem raster -no-webkit -no-sql-ibase -no-sql-mysql -no-sql-psql '
'-no-sql-odbc -no-sql-sqlite -no-sql-tds -nomake demos -nomake examples -nomake tools\n'
'touch %s' % (
build_root, qt_env['ENV']['mod_env'], optdir, qt_target))

qt_configure = qt_env.Command(
    qt_target, [qt_extract, qt_patch],
    [qt_env.MultiCommand(configure_cmd)])

# [8] Build qt
ld = '%s -shared' % qt_env['ENV']['CXX']
make_cmd = '%s LD_SHARED="%s"' % (make_cmd_cpu, ld)
qt_target = '%s/.build_qt' % current_dir
qt_build = qt_env.Command(
    qt_target, qt_configure,
    [qt_env.MultiCommand(
        'cd %s\n'
        '%s%s\n'
        'touch %s' % (build_root, qt_env['ENV']['mod_env'], make_cmd,
                      qt_target))])

# [9] Create qt master installer
make_cmd = 'make LD_SHARED="%s"' % (ld)
install_root = '%s/install' % current_dir
other_dir = '%s/share/doc/packages/%s' % (install_root, ge_version)
qt_target = '%s/.install' % current_dir
qt_install = qt_env.Command(
    qt_target, qt_build,
    [qt_env.MultiCommand(
        'cd %s\n'
        '%s %s INSTALL_ROOT=%s install\n'
        'mkdir -p %s\n'
        'cp -pr LICENSE.* %s\n'
        'touch %s' % (
            build_root, qt_env['ENV']['mod_env'], make_cmd, install_root,
            other_dir, other_dir, qt_target))])

# [11] Install these into various directories as required for build
qt_target = '%s/.install_for_build' % current_dir
final_install_root = install_root + "/opt/google"
qt_install_build = qt_env.Command(
    qt_target, [qt_install ],
    [qt_env.rsync_cmd % (
        '%s/bin/' % final_install_root,
        '%s/' % Dir(qt_env.exportdirs['bin']).abspath),
     qt_env.rsync_cmd % (
         '%s/include/' % final_install_root,
         '%s/include/' % Dir(qt_env.exportdirs['root']).abspath),
     qt_env.rsync_cmd % (
         '%s/lib/' % final_install_root,
         '%s/' % Dir(qt_env.exportdirs['lib']).abspath),
     Touch('$TARGET')])
Default(qt_install_build)

if 'install' in COMMAND_LINE_TARGETS:
  # Copies qt tools to /opt/google/bin folder.
  qt_env.InstallFileOrDir(
      '%s/bin/' % final_install_root,
      '%s/opt/google/bin' % qt_env.installdirs['common_root'],
      qt_install_build, 'install')

  # Copies qt libraries from ../install/lib/ folder to /opt/google/lib.
  qt_env.Alias(
      'install', [qt_install_build],
      [qt_env.rsync_excl_cmd %(
          'python%s' % qt_env['python_major_version'],
          '%s/lib/' % final_install_root,
          '%s/opt/google/lib' % qt_env.installdirs['common_root'])])

  # copy qt docs to /opt/google/share folder.
  qt_env.InstallFileOrDir(
      '%s/share/' % final_install_root,
      '%s/opt/google/share/' % qt_env.installdirs['common_root'],
      qt_install_build, 'install')

Return('qt_extract qt_install_build')
